## ä¸€ã€å¼‚æ­¥ç»„ä»¶ defineAsyncComponent

> * ä½¿ç”¨**`defineAsyncComponent`** æ–¹æ³•å®šä¹‰å¼‚æ­¥ç»„ä»¶
>
> - **`component` **é€‰é¡¹è¢«é‡å‘½åä¸º **`loader`**
>
> - ä¸ 2.x ä¸åŒï¼ŒLoader å‡½æ•°æœ¬èº«**ä¸å†æ¥æ”¶ `resolve` å’Œ `reject`** å‚æ•°ï¼Œä¸”**å¿…é¡»è¿”å›ä¸€ä¸ª Promise**
>
>   ```js
>   // 2.x ç‰ˆæœ¬
>   const oldAsyncComponent = (resolve, reject) => {
>     /* ... */
>   }
>                 
>   // 3.x ç‰ˆæœ¬
>   const asyncComponent = defineAsyncComponent(
>     () =>
>       new Promise((resolve, reject) => {
>         resolve({
>           template: '<div>I am async!</div>'
>         })
>         // ä¹Ÿå¯ä»¥è°ƒç”¨ reject(reason)ï¼Œæ¥è¡¨ç¤ºåŠ è½½å¤±è´¥
>         /* ... */
>       })
>   )
>   ```

### Vue 2.x

å¼‚æ­¥ç»„ä»¶æ˜¯é€šè¿‡å°†ç»„ä»¶å®šä¹‰ä¸ºè¿”å› Promise çš„å‡½æ•°æ¥åˆ›å»ºçš„ï¼Œå¦‚ï¼š

```js
const asyncModal = () => import('./Modal.vue')
```

æˆ–è€…ï¼Œå¯¹äºå¸¦æœ‰é€‰é¡¹çš„æ›´é«˜é˜¶çš„ç»„ä»¶è¯­æ³•ï¼š

```js
const asyncModal = {
  component: () => import('./Modal.vue'),
  delay: 200,
  timeout: 3000,
  error: ErrorComponent,
  loading: LoadingComponent
}
```

### Vue 3.x

> åœ¨ Vue 3 ä¸­ï¼Œç”±äºå‡½æ•°å¼ç»„ä»¶è¢«å®šä¹‰ä¸ºçº¯å‡½æ•°ï¼Œå› æ­¤å¼‚æ­¥ç»„ä»¶éœ€è¦é€šè¿‡å°†å…¶åŒ…è£¹åœ¨ **`defineAsyncComponent`** æ–¹æ³•ä¸­æ¥å®šä¹‰ï¼š

```js
import { defineAsyncComponent } from 'vue'
import ErrorComponent from './components/ErrorComponent.vue'
import LoadingComponent from './components/LoadingComponent.vue'

// ä¸å¸¦é€‰é¡¹çš„å¼‚æ­¥ç»„ä»¶
const asyncModal = defineAsyncComponent(() => import('./Modal.vue'))

// å¸¦é€‰é¡¹çš„å¼‚æ­¥ç»„ä»¶
const asyncModalWithOptions = defineAsyncComponent({
  loader: () => import('./Modal.vue'),
  delay: 200,
  timeout: 3000,
  errorComponent: ErrorComponent,
  loadingComponent: LoadingComponent
})
```

**ä¸ Suspense ä¸€èµ·ä½¿ç”¨**

å¼‚æ­¥ç»„ä»¶åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯*å¯æŒ‚èµ·*çš„ã€‚è¿™æ„å‘³ç€å¦‚æœå®ƒåœ¨çˆ¶é“¾ä¸­æœ‰ä¸€ä¸ª `<Suspense>`ï¼Œå®ƒå°†è¢«è§†ä¸ºè¯¥ `<Suspense>` çš„å¼‚æ­¥ä¾èµ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŠ è½½çŠ¶æ€å°†ç”± `<Suspense>` æ§åˆ¶ï¼Œç»„ä»¶è‡ªèº«çš„åŠ è½½ã€é”™è¯¯ã€å»¶è¿Ÿå’Œè¶…æ—¶é€‰é¡¹éƒ½å°†è¢«å¿½ç•¥ã€‚

é€šè¿‡åœ¨å…¶é€‰é¡¹ä¸­æŒ‡å®š **`suspensible: false`**ï¼Œå¼‚æ­¥ç»„ä»¶å¯ä»¥é€€å‡º `Suspense` æ§åˆ¶ï¼Œå¹¶å§‹ç»ˆæ§åˆ¶è‡ªå·±çš„åŠ è½½çŠ¶æ€ã€‚

## äºŒã€ç»„ä»¶`emits`é€‰é¡¹

> **`emits`** é€‰é¡¹ï¼Œå’Œç°æœ‰çš„ **`props`** é€‰é¡¹ç±»ä¼¼ã€‚è¿™ä¸ªé€‰é¡¹å¯ä»¥ç”¨æ¥å®šä¹‰ä¸€ä¸ªç»„ä»¶å¯ä»¥å‘å…¶çˆ¶ç»„ä»¶è§¦å‘çš„äº‹ä»¶ã€‚
>
> å¹¶ä¸”ï¼Œ`emits` é€‰é¡¹ä¸­åˆ—å‡ºçš„äº‹ä»¶**ä¸ä¼š**ä»ç»„ä»¶çš„æ ¹å…ƒç´ ç»§æ‰¿ï¼Œä¹Ÿå°†ä» **`$attrs`** property ä¸­ç§»é™¤ï¼Œå¦åˆ™å°†éš **`$attrs`** ç»‘å®šåˆ°ç»„ä»¶çš„æ ¹èŠ‚ç‚¹ä¸Š

emits å¯ä»¥æ˜¯æ•°ç»„æˆ–å¯¹è±¡ï¼Œä»ç»„ä»¶è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œemits å¯ä»¥æ˜¯ç®€å•çš„æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ï¼Œåè€…å…è®¸é…ç½®äº‹ä»¶éªŒè¯ã€‚

åœ¨å¯¹è±¡è¯­æ³•ä¸­ï¼Œæ¯ä¸ª property çš„å€¼å¯ä»¥ä¸º `null` æˆ–éªŒè¯å‡½æ•°ã€‚éªŒè¯å‡½æ•°å°†æ¥æ”¶ä¼ é€’ç»™ `$emit` è°ƒç”¨çš„å…¶ä»–å‚æ•°ã€‚å¦‚æœ `this.$emit('foo',1)` è¢«è°ƒç”¨ï¼Œ`foo` çš„ç›¸åº”éªŒè¯å‡½æ•°å°†æ¥æ”¶å‚æ•° `1`ã€‚éªŒè¯å‡½æ•°åº”è¿”å›å¸ƒå°”å€¼ï¼Œä»¥è¡¨ç¤ºäº‹ä»¶å‚æ•°æ˜¯å¦æœ‰æ•ˆã€‚

```js
const app = createApp({})

// æ•°ç»„è¯­æ³•
app.component('todo-item', {
  emits: ['check'],
  created() {
    this.$emit('check')
  }
})

// å¯¹è±¡è¯­æ³•
app.component('reply-form', {
  emits: {
    // æ²¡æœ‰éªŒè¯å‡½æ•°
    click: null,
    // å¸¦æœ‰éªŒè¯å‡½æ•°
    submit: payload => {
      if (payload.email && payload.password) {
        return true
      } else {
        console.warn(`Invalid submit event payload!`)
        return false
      }
    }
  }
})
```

å¯¹äºå‘å…¶çˆ¶ç»„ä»¶é€ä¼ åŸç”Ÿäº‹ä»¶çš„ç»„ä»¶æ¥è¯´ï¼Œè¿™ä¼šå¯¼è‡´æœ‰ä¸¤ä¸ªäº‹ä»¶è¢«è§¦å‘ï¼š

```vue
<template>
  <button v-on:click="$emit('click', $event)">OK</button>
</template>
<script>
export default {
  emits: [] // ä¸å£°æ˜äº‹ä»¶
}
</script>
```

å½“ä¸€ä¸ªçˆ¶çº§ç»„ä»¶æ‹¥æœ‰ `click` äº‹ä»¶çš„ç›‘å¬å™¨æ—¶ï¼š

```html
<my-button v-on:click="handleClick"></my-button>
```

è¯¥äº‹ä»¶ç°åœ¨ä¼šè¢«è§¦å‘*ä¸¤æ¬¡*:

- ä¸€æ¬¡æ¥è‡ª `$emit()`ã€‚
- å¦ä¸€æ¬¡æ¥è‡ªåº”ç”¨åœ¨æ ¹å…ƒç´ ä¸Šçš„åŸç”Ÿäº‹ä»¶ç›‘å¬å™¨ã€‚

## ä¸‰ã€ç»„ä»¶ `expose` é€‰é¡¹

> - ä¸€ä¸ªå°†æš´éœ²åœ¨å…¬å…±ç»„ä»¶å®ä¾‹ä¸Šçš„ property åˆ—è¡¨ã€‚
>
>   é»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡ [`$refs`](https://v3.cn.vuejs.org/api/instance-properties.html#refs)ã€[`$parent`](https://v3.cn.vuejs.org/api/instance-properties.html#parent) æˆ– [`$root`](https://v3.cn.vuejs.org/api/instance-properties.html#root) è®¿é—®åˆ°çš„å…¬å…±å®ä¾‹ä¸æ¨¡æ¿ä½¿ç”¨çš„ç»„ä»¶å†…éƒ¨å®ä¾‹æ˜¯ä¸€æ ·çš„ã€‚`expose` é€‰é¡¹å°†é™åˆ¶å…¬å…±å®ä¾‹å¯ä»¥è®¿é—®çš„ propertyã€‚
>
>   ç”± Vue è‡ªèº«å®šä¹‰çš„ propertyï¼Œæ¯”å¦‚ `$el` å’Œ `$parent`ï¼Œå°†å§‹ç»ˆå¯ä»¥è¢«å…¬å…±å®ä¾‹è®¿é—®ï¼Œå¹¶ä¸éœ€è¦åˆ—å‡ºã€‚

```js
export default {
  // increment å°†è¢«æš´éœ²ï¼Œ
  // ä½† count åªèƒ½è¢«å†…éƒ¨è®¿é—®
  expose: ['increment'],

  data() {
    return {
      count: 0
    }
  },

  methods: {
    increment() {
      this.count++
    }
  }
}
```

## å››ã€ç‰‡æ®µ

### Vue 2.x

åœ¨ 2.x ä¸­ï¼Œç”±äºä¸æ”¯æŒå¤šæ ¹èŠ‚ç‚¹ç»„ä»¶ï¼Œè®¸å¤šç»„ä»¶è¢«åŒ…è£¹åœ¨äº†ä¸€ä¸ª `<div>` ä¸­ã€‚

ä¸€ä¸ªé prop çš„ attribute æ˜¯æŒ‡ä¼ å‘ä¸€ä¸ªç»„ä»¶ï¼Œä½†æ˜¯è¯¥ç»„ä»¶å¹¶æ²¡æœ‰ç›¸åº” [props](https://v3.cn.vuejs.org/guide/component-props.html) æˆ– [emits](https://v3.cn.vuejs.org/guide/component-custom-events.html#å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶) å®šä¹‰çš„ attributeã€‚å¸¸è§çš„ç¤ºä¾‹åŒ…æ‹¬ `class`ã€`style` å’Œ `id` attributeã€‚å¯ä»¥é€šè¿‡ `$attrs` property è®¿é—®é‚£äº› attributeã€‚

1. å½“ç»„ä»¶è¿”å›å•ä¸ªæ ¹èŠ‚ç‚¹æ—¶ï¼Œé prop çš„ attribute å°†é»˜è®¤è‡ªåŠ¨æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹çš„ attribute ä¸­ã€‚

2. å¦‚æœä½ **ä¸**å¸Œæœ›ç»„ä»¶çš„æ ¹å…ƒç´ ç»§æ‰¿ attributeï¼Œå¯ä»¥åœ¨ç»„ä»¶çš„é€‰é¡¹ä¸­è®¾ç½® `inheritAttrs: false`ã€‚

   ç¦ç”¨ attribute ç»§æ‰¿çš„å¸¸è§åœºæ™¯æ˜¯éœ€è¦å°† attribute åº”ç”¨äºæ ¹èŠ‚ç‚¹ä¹‹å¤–çš„å…¶ä»–å…ƒç´ ã€‚

### Vue 3.x

åœ¨ 3.x ä¸­ï¼Œç»„ä»¶å¯ä»¥åŒ…å«å¤šä¸ªæ ¹èŠ‚ç‚¹ï¼ä½†æ˜¯ï¼Œè¿™è¦æ±‚å¼€å‘è€…æ˜¾å¼å®šä¹‰ attribute åº”è¯¥åˆ†å¸ƒåœ¨å“ªé‡Œã€‚

```html
<!-- Layout.vue -->
<template>
  <header>...</header>
  <main v-bind="$attrs">...</main>
  <footer>...</footer>
</template>
```

## äº”ã€suspense ([API å¯èƒ½éšæ—¶ä¼šå‘ç”Ÿå˜åŠ¨](https://v3.cn.vuejs.org/guide/migration/suspense.html))

> åœ¨æ­£ç¡®æ¸²æŸ“ç»„ä»¶ä¹‹å‰è¿›è¡Œä¸€äº›å¼‚æ­¥è¯·æ±‚æ˜¯å¾ˆå¸¸è§çš„äº‹ã€‚ç»„ä»¶é€šå¸¸ä¼šåœ¨æœ¬åœ°å¤„ç†è¿™ç§é€»è¾‘ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹è¿™æ˜¯éå¸¸å®Œç¾çš„åšæ³•ã€‚
>
> **è¯¥ `<suspense>` ç»„ä»¶æä¾›äº†å¦ä¸€ä¸ªæ–¹æ¡ˆï¼Œå…è®¸å°†ç­‰å¾…è¿‡ç¨‹æå‡åˆ°ç»„ä»¶æ ‘ä¸­å¤„ç†ï¼Œè€Œä¸æ˜¯åœ¨å•ä¸ªç»„ä»¶ä¸­**ã€‚

```vue
<template>
  <suspense>
    <!-- <suspense> ç»„ä»¶æœ‰ä¸¤ä¸ªæ’æ§½ã€‚å®ƒä»¬éƒ½åªæ¥æ”¶ä¸€ä¸ªç›´æ¥å­èŠ‚ç‚¹  -->
    <!-- default æ’æ§½é‡Œçš„èŠ‚ç‚¹ä¼šå°½å¯èƒ½å±•ç¤ºå‡ºæ¥ã€‚å¦‚æœä¸èƒ½ï¼Œåˆ™å±•ç¤º fallback æ’æ§½é‡Œçš„èŠ‚ç‚¹ -->
    <template #default>
      <todo-list />
    </template>
    <template #fallback>
      <div>
        Loading...
      </div>
    </template>
  </suspense>
</template>
<script>
export default {
  components: {
    TodoList: defineAsyncComponent(() => import('./TodoList.vue'))
  }
}
</script>
```

é‡è¦çš„æ˜¯ï¼Œå¼‚æ­¥ç»„ä»¶ä¸éœ€è¦ä½œä¸º `<suspense>` çš„ç›´æ¥å­èŠ‚ç‚¹ã€‚å®ƒå¯ä»¥å‡ºç°åœ¨ç»„ä»¶æ ‘ä»»æ„æ·±åº¦çš„ä½ç½®ï¼Œä¸”ä¸éœ€è¦å‡ºç°åœ¨å’Œ `<suspense>` è‡ªèº«ç›¸åŒçš„æ¨¡æ¿ä¸­ã€‚åªæœ‰æ‰€æœ‰çš„åä»£ç»„ä»¶éƒ½å‡†å¤‡å°±ç»ªï¼Œè¯¥å†…å®¹æ‰ä¼šè¢«è®¤ä¸ºè§£æå®Œæ¯•ã€‚

å¦ä¸€ä¸ª**è§¦å‘ `fallback` çš„æ–¹å¼æ˜¯è®©åä»£ç»„ä»¶ä» `setup` å‡½æ•°ä¸­è¿”å›ä¸€ä¸ª Promise**ã€‚é€šå¸¸è¿™æ˜¯é€šè¿‡ **`async`** å®ç°çš„ï¼Œè€Œä¸æ˜¯æ˜¾å¼åœ°è¿”å›ä¸€ä¸ª Promiseï¼š

```js
export default {
  async setup() {
    // åœ¨ `setup` å†…éƒ¨ä½¿ç”¨ `await` éœ€è¦éå¸¸å°å¿ƒ
    // å› ä¸ºå¤§å¤šæ•°ç»„åˆå¼ API å‡½æ•°åªä¼šåœ¨
    // ç¬¬ä¸€ä¸ª `await` ä¹‹å‰å·¥ä½œ
    const data = await loadData()

    // å®ƒéšæ€§åœ°åŒ…è£¹åœ¨ä¸€ä¸ª Promise å†…
    // å› ä¸ºå‡½æ•°æ˜¯ `async` çš„
    return {
      // ...
    }
  }
}
```

### å­ç»„ä»¶æ›´æ–°

ä¸€æ—¦ `<suspense>` çš„ `default` æ’æ§½é‡Œçš„å†…å®¹è¢«è§£æï¼Œåˆ™å®ƒåªæœ‰åœ¨ `default` æ ¹ç»“ç‚¹è¢«æ›¿æ¢çš„æ—¶å€™æ‰èƒ½è¢«å†æ¬¡è§¦å‘ã€‚è€Œæ ‘é‡Œçš„æ·±å±‚åµŒå¥—ç»„ä»¶ä¸è¶³ä»¥è®© `<suspense>` å›åˆ°ç­‰å¾…çŠ¶æ€ã€‚

å¦‚æœæ ¹ç»“ç‚¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå®ƒä¼šè§¦å‘ `pending` äº‹ä»¶ã€‚ç„¶è€Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¸ä¼šæ›´æ–° DOM ä»¥å±•ç¤º `fallback` å†…å®¹ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå®ƒä¼šç»§ç»­å±•ç¤ºæ—§çš„ DOMï¼Œç›´åˆ°æ–°ç»„ä»¶å‡†å¤‡å°±ç»ªã€‚è¿™ä¸ªè¡Œä¸ºå¯ä»¥é€šè¿‡ **`timeout`** prop è¿›è¡Œæ§åˆ¶( **defineAsyncComponentç»„ä»¶çš„timeout** )ã€‚è¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªæ¯«ç§’æ•°ï¼Œå‘Šè¯‰ `<suspense>` ç»„ä»¶å¤šä¹…ä¹‹åå±•ç¤º `fallback`ã€‚å¦‚æœè¿™ä¸ªå€¼æ˜¯ `0` åˆ™è¡¨ç¤ºå®ƒåœ¨ `<suspense>` è¿›å…¥ç­‰å¾…çŠ¶æ€æ—¶ä¼šç«‹å³æ˜¾ç¤ºã€‚

### äº‹ä»¶

é™¤äº† `pending` äº‹ä»¶ä»¥å¤–ï¼Œ`<suspense>` ç»„ä»¶è¿˜æ‹¥æœ‰ `resolve` å’Œ `fallback` äº‹ä»¶ã€‚`resolve` äº‹ä»¶ä¼šåœ¨ `default` æ’æ§½å®Œæˆæ–°å†…å®¹çš„è§£æä¹‹åè¢«è§¦å‘ã€‚`fallback` äº‹ä»¶ä¼šåœ¨ `fallback` æ’æ§½çš„å†…å®¹å±•ç¤ºçš„æ—¶å€™è¢«è§¦å‘ã€‚

**è¿™äº›äº‹ä»¶å¯ä»¥ç”¨åœ¨è¯¸å¦‚å½“æ–°ç»„ä»¶åŠ è½½æ—¶åœ¨æ—§ DOM ä¸Šå±•ç¤ºä¸€ä¸ªåŠ è½½æ ‡è¯†ç­‰åœºæ™¯**

### å’Œå…¶å®ƒç»„ä»¶ç»“åˆ

å°† `<suspense>` è·Ÿ [``](https://v3.cn.vuejs.org/api/built-in-components.html#transition) å’Œ [``](https://v3.cn.vuejs.org/api/built-in-components.html#keep-alive) ç»„ä»¶ç›¸ç»“åˆæ˜¯å¸¸è§çš„æƒ…å½¢ã€‚è¿™äº›ç»„ä»¶çš„åµŒå¥—é¡ºåºå¯¹äºå®ƒä»¬çš„æ­£ç¡®å·¥ä½œå¾ˆé‡è¦ã€‚

é¢å¤–çš„ï¼Œè¿™äº›ç»„ä»¶ç»å¸¸ç”¨äºè¡”æ¥ [Vue Router](https://next.router.vuejs.org/zh/) çš„ `<router-view>` ç»„ä»¶ã€‚

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åµŒå¥—è¿™äº›ç»„ä»¶ä»¥è®©å®ƒä»¬çš„è¡¨ç°ç¬¦åˆé¢„æœŸã€‚è‹¥è¦ç®€åŒ–è¿™ä¸ªç»„åˆä½ å¯ä»¥ç§»é™¤ä¸éœ€è¦çš„ç»„ä»¶ï¼š

```html
<router-view v-slot="{ Component }">
  <template v-if="Component">
    <transition mode="out-in">
      <keep-alive>
        <suspense>
          <component :is="Component"></component>
          <template #fallback>
            <div>
              Loading...
            </div>
          </template>
        </suspense>
      </keep-alive>
    </transition>
  </template>
</router-view>
```

Vue Router æœ‰å†…ç½®çš„åŸºäºåŠ¨æ€å¯¼å…¥çš„[ç»„ä»¶æ‡’åŠ è½½](https://next.router.vuejs.org/zh/guide/advanced/lazy-loading.html)æ”¯æŒã€‚å®ƒå’Œå¼‚æ­¥ç»„ä»¶æœ‰æ‰€åŒºåˆ«ï¼Œå¹¶ä¸”å½“å‰ä¸ä¼šè§¦å‘ `<suspense>`ã€‚ä¸è¿‡å®ƒä»¬ä»ç„¶å¯ä»¥åŒ…å«å¼‚æ­¥ç»„ä»¶ä½œä¸ºåä»£ï¼Œè¿™æ ·å®ƒä»¬è¿˜æ˜¯å¯ä»¥æ­£å¸¸è§¦å‘ `<suspense>`ã€‚

### ç”¨ `onErrorCaptured` æ•è· `suspense`ä¸­å‡ºç°çš„é”™è¯¯

```vue
<script>
	import { ref,onErrorCaptured } from 'vue';
  setup() {
    const captureError = ref(null);
      onErrorCaptured((e: any) => { // æ•è·suspenseä¸­å¯èƒ½çš„é”™è¯¯
        captureError.value = e;
        return true; // è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦ç»§ç»­å‘ä¸Šä¼ æ’­
      })
    return {
      captureError
    }
  }
</script>
```

## å…­ã€Teleport ç»„ä»¶

> æœ‰æ—¶ç»„ä»¶æ¨¡æ¿çš„ä¸€éƒ¨åˆ†é€»è¾‘ä¸Šå±äºè¯¥ç»„ä»¶ï¼Œè€Œä»æŠ€æœ¯è§’åº¦æ¥çœ‹ï¼Œæœ€å¥½å°†æ¨¡æ¿çš„è¿™ä¸€éƒ¨åˆ†ç§»åŠ¨åˆ° DOM ä¸­ Vue app ä¹‹å¤–çš„å…¶ä»–ä½ç½®

### props

- **to - `string`**

  > éœ€è¦ propï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„æŸ¥è¯¢é€‰æ‹©å™¨æˆ– HTMLElement (å¦‚æœåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨)ã€‚æŒ‡å®šå°†åœ¨å…¶ä¸­ç§»åŠ¨ `<teleport>` å†…å®¹çš„ç›®æ ‡å…ƒç´ 

  ```html
  <!-- æ­£ç¡® -->
  <teleport to="#some-id" />
  <teleport to=".some-class" />
  <teleport to="[data-teleport]" />
  
  <!-- é”™è¯¯ -->
  <teleport to="h1" />
  <teleport to="some-string" />
  ```

- **disabled - `boolean`**

  > æ­¤å¯é€‰å±æ€§å¯ç”¨äºç¦ç”¨ `<teleport>` çš„åŠŸèƒ½ï¼Œè¿™æ„å‘³ç€å…¶æ’æ§½å†…å®¹å°†ä¸ä¼šç§»åŠ¨åˆ°ä»»ä½•ä½ç½®ï¼Œè€Œæ˜¯åœ¨ä½ åœ¨å‘¨å›´çˆ¶ç»„ä»¶ä¸­æŒ‡å®šäº† `<teleport>` çš„ä½ç½®æ¸²æŸ“ã€‚

  ```html
  <teleport to="#popup" :disabled="displayVideoInline">
    <video src="./my-movie.mp4">
  </teleport>
  ```

Teleport æä¾›äº†ä¸€ç§å¹²å‡€çš„æ–¹æ³•ï¼Œå…è®¸æˆ‘ä»¬æ§åˆ¶åœ¨ DOM ä¸­å“ªä¸ªçˆ¶èŠ‚ç‚¹ä¸‹æ¸²æŸ“äº† HTMLï¼Œè€Œä¸å¿…æ±‚åŠ©äºå…¨å±€çŠ¶æ€æˆ–å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ªç»„ä»¶ã€‚

è®©æˆ‘ä»¬ä¿®æ”¹ `modal-button` ä»¥ä½¿ç”¨ `<teleport>`ï¼Œå¹¶å‘Šè¯‰ Vue â€œå°†è¿™ä¸ª HTML **ä¼ é€**åˆ°â€˜**body**â€™æ ‡ç­¾ä¸‹â€ã€‚

```js
app.component('modal-button', {
  template: `
    <button @click="modalOpen = true">
        Open full screen modal! (With teleport!)
    </button>

    <teleport to="body">
      <div v-if="modalOpen" class="modal">
        <div>
          I'm a teleported modal! 
          (My parent is "body")
          <button @click="modalOpen = false">
            Close
          </button>
        </div>
      </div>
    </teleport>
  `,
  data() {
    return { 
      modalOpen: false
    }
  }
})
```

### åœ¨åŒä¸€ç›®æ ‡ä¸Šä½¿ç”¨å¤šä¸ª teleport

ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹åœºæ™¯æ˜¯ä¸€ä¸ªå¯é‡ç”¨çš„ `<Modal>` ç»„ä»¶ï¼Œå®ƒå¯èƒ½åŒæ—¶æœ‰å¤šä¸ªå®ä¾‹å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¤šä¸ª `<teleport>` ç»„ä»¶å¯ä»¥å°†å…¶å†…å®¹æŒ‚è½½åˆ°åŒä¸€ä¸ªç›®æ ‡å…ƒç´ ã€‚é¡ºåºå°†æ˜¯ä¸€ä¸ªç®€å•çš„è¿½åŠ â€”â€”ç¨åæŒ‚è½½å°†ä½äºç›®æ ‡å…ƒç´ ä¸­è¾ƒæ—©çš„æŒ‚è½½ä¹‹åã€‚

```html
<teleport to="#modals">
  <div>A</div>
</teleport>
<teleport to="#modals">
  <div>B</div>
</teleport>

<!-- result-->
<div id="modals">
  <div>A</div>
  <div>B</div>
</div>
```

## ä¸ƒã€Composition API: ç±»ä¼¼React Hooks

> ä¸ºvueåº”ç”¨æä¾›æ›´å¥½çš„é€»è¾‘å¤ç”¨å’Œä»£ç ç»„ç»‡
>
> 1. **ref** å®šä¹‰åŸºç¡€æ•°æ®ç±»å‹çš„å“åº”å¼æ•°æ®
>
> 2. **reactive** å®šä¹‰å¼•ç”¨æ•°æ®ç±»å‹çš„å“åº”å¼æ•°æ®
>
> 3. **setup(props, { attrs, slots, emit, expose }) { â€¦ }** setupå‡½æ•°æ˜¯ **Composition API** çš„å…¥å£å‡½æ•°ï¼Œ `setup` è¿”å›çš„æ‰€æœ‰å†…å®¹éƒ½æš´éœ²ç»™ç»„ä»¶çš„å…¶ä½™éƒ¨åˆ† (è®¡ç®—å±æ€§ã€æ–¹æ³•ã€ç”Ÿå‘½å‘¨æœŸé’©å­ç­‰ç­‰) ä»¥åŠç»„ä»¶çš„æ¨¡æ¿ã€‚
>
>    - **attrs**ï¼šAttribute (éå“åº”å¼å¯¹è±¡ï¼Œç­‰åŒäº **$attrs**)
>
>    - **slots**ï¼šæ’æ§½ (éå“åº”å¼å¯¹è±¡ï¼Œç­‰åŒäº **$slots**)
>
>      > **`attrs`** å’Œ **`slots`** æ˜¯æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼Œå®ƒä»¬æ€»æ˜¯ä¼šéšç»„ä»¶æœ¬èº«çš„æ›´æ–°è€Œæ›´æ–°ã€‚è¿™æ„å‘³ç€ä½ åº”è¯¥é¿å…å¯¹å®ƒä»¬è¿›è¡Œè§£æ„ï¼Œå¹¶å§‹ç»ˆä»¥ `attrs.x` æˆ– `slots.x` çš„æ–¹å¼å¼•ç”¨ propertyã€‚
>      >
>      > **æ³¨æ„**ï¼šä¸ `props` ä¸åŒï¼Œ`attrs` å’Œ `slots` çš„ property æ˜¯**é**å“åº”å¼çš„ã€‚å¦‚æœä½ æ‰“ç®—æ ¹æ® `attrs` æˆ– `slots` çš„æ›´æ”¹åº”ç”¨å‰¯ä½œç”¨ï¼Œé‚£ä¹ˆåº”è¯¥åœ¨ `onBeforeUpdate` ç”Ÿå‘½å‘¨æœŸé’©å­ä¸­æ‰§è¡Œæ­¤æ“ä½œã€‚
>
>    - **emit**ï¼šè§¦å‘äº‹ä»¶ (æ–¹æ³•ï¼Œç­‰åŒäº $emit)
>
>    - **expose**ï¼šæš´éœ²å…¬å…± property (å‡½æ•°)

### setupé€‰é¡¹

> **æ³¨æ„ğŸ“¢ï¼š**åœ¨ `setup` ä¸­ä½ åº”è¯¥é¿å…ä½¿ç”¨ `this`ï¼Œå› ä¸ºå®ƒä¸ä¼šæ‰¾åˆ°ç»„ä»¶å®ä¾‹ï¼Œè¯¥é€‰é¡¹åœ¨ç»„ä»¶åˆ›å»º**ä¹‹å‰**æ‰§è¡Œã€‚`setup` çš„è°ƒç”¨å‘ç”Ÿåœ¨ **`data`** propertyã€**`computed`** property ã€ **`methods`** ã€**`refs` (æ¨¡æ¿ ref)** è¢«è§£æä¹‹å‰ï¼Œæ‰€ä»¥å®ƒä»¬æ— æ³•åœ¨ `setup` ä¸­è¢«è·å–ï¼Œä¸€æ—¦ `props` è¢«è§£æï¼Œå°±å°†ä½œä¸ºç»„åˆå¼ API çš„å…¥å£ã€‚

```vue
<script>
  // refå‡½æ•°åªèƒ½ç›‘å¬ç®€å•ç±»å‹çš„å˜åŒ–ï¼Œä¸èƒ½ç›‘å¬å¤æ‚ç±»å‹çš„å˜åŒ–(å¯¹è±¡/æ•°ç»„)
  // isRef/isReactiveåˆ†åˆ«ç›‘å¬æ˜¯å¦ä¸ºrefã€reactiveå£°æ˜çš„æ•°æ®å¯¹è±¡
import { ref, reactive, isRef, isReactive, toRefs, toRef } from "vue";
export default {
  props: {
    title: String
  },
  // setupå‡½æ•°æ˜¯ç»„åˆAPIçš„å…¥å£å‡½æ•°,setupåœ¨beforeCreateç”Ÿå‘½é’©å­ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨dataå’Œmethodsï¼Œæ‰€ä»¥setupå‡½æ•°ä¸­thisä¿®æ”¹æˆäº†undefined
  setup(props, { attrs, slots, emit }) {
    // å› ä¸º props æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ ES6 è§£æ„ï¼Œå®ƒä¼šæ¶ˆé™¤ prop çš„å“åº”æ€§
    // å¦‚æœéœ€è¦è§£æ„ propï¼Œå¯ä»¥åœ¨ setup å‡½æ•°ä¸­ä½¿ç”¨ toRefs å‡½æ•°æ¥å®Œæˆæ­¤æ“ä½œ
    // ä½¿ç”¨ `toRefs` åˆ›å»ºå¯¹ `props` ä¸­çš„ `user` property çš„å“åº”å¼å¼•ç”¨. 
    // æ˜¯ä¸ºäº†ç¡®ä¿æˆ‘ä»¬çš„ä¾¦å¬å™¨èƒ½å¤Ÿæ ¹æ® user prop çš„å˜åŒ–åšå‡ºååº”
    const { title } = toRefs(props);
    
    // å¦‚æœ title æ˜¯å¯é€‰çš„ propï¼Œåˆ™ä¼ å…¥çš„ props ä¸­å¯èƒ½æ²¡æœ‰ title ã€‚
    // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒtoRefs å°†ä¸ä¼šä¸º title åˆ›å»ºä¸€ä¸ª ref ã€‚ä½ éœ€è¦ä½¿ç”¨ toRef æ›¿ä»£å®ƒï¼š
    const title = toRef(props, 'title')
  	console.log(title.value)
    
    // let count = 0; // è¿™æ ·å®šä¹‰åˆ™æ•°æ®ä¸æ˜¯å“åº”å¼çš„
    // å®šä¹‰äº†ä¸€ä¸ªåå«countçš„å˜é‡ï¼Œè¯¥å˜é‡åˆå§‹å€¼ä¸º0ï¼Œè¯¥å˜é‡æ”¹å˜ä¹‹åï¼Œvueè‡ªåŠ¨æ›´æ–°UI
    // refçš„æœ¬è´¨è¿˜æ˜¯reactiveï¼Œå½“æˆ‘ä»¬ç»™refä¼ é€’ä¸€ä¸ªå€¼åï¼Œrefå‡½æ•°åº•å±‚ä¼šè‡ªåŠ¨å°†refè½¬æ¢ä¸ºreactive
    // ref(0) å˜ä¸º reactive({value:0}),æ‰€ä»¥èµ‹å€¼æ—¶åº”ä¸º count.value = xx;
    let count = ref(0); 
      
    // åœ¨ç»„åˆAPIä¸­ï¼Œå¦‚æœæƒ³å®šä¹‰æ–¹æ³•ï¼Œä¸ç”¨å®šä¹‰åˆ°methodsä¸­ï¼Œç›´æ¥å®šä¹‰å³å¯
    function mf() {
      count.value += 1;
    }
     let state = reactive({
         stus:[]
     })
    // æ³¨æ„ï¼šåœ¨ç»„åˆAPIä¸­å®šä¹‰çš„å˜é‡/æ–¹æ³•ï¼Œè¦æƒ³åœ¨å¤–ç•Œä¸­ä½¿ç”¨ï¼Œå¿…é¡»é€šè¿‡return {xxx} æš´éœ²å‡ºå»
    return { count, mf, stus };
  }
};
</script>
```

<img src="../../../assets/react/%E5%AF%B9%E6%AF%94.jpg" style="zoom: 80%;" />

#### 1. `ref`

> **`ref`** æ¥æ”¶å‚æ•°å¹¶å°†å…¶åŒ…è£¹åœ¨ä¸€ä¸ªå¸¦æœ‰ **`value`** property çš„å¯¹è±¡ä¸­è¿”å›ï¼Œç„¶åå¯ä»¥ä½¿ç”¨è¯¥ property è®¿é—®æˆ–æ›´æ”¹å“åº”å¼å˜é‡çš„å€¼

```js
import { ref } from 'vue'

const counter = ref(0)

console.log(counter) // { value: 0 }
console.log(counter.value) // 0

counter.value++
console.log(counter.value) // 1
```

#### 2.`reactive`

#### 3. `watch` å“åº”å¼æ›´æ”¹

> ä» Vue å¯¼å…¥çš„ `watch` å‡½æ•°æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚å®ƒæ¥å— 3 ä¸ªå‚æ•°ï¼š
>
> - ä¸€ä¸ªæƒ³è¦ä¾¦å¬çš„**å“åº”å¼å¼•ç”¨**æˆ– getter å‡½æ•°
> - ä¸€ä¸ªå›è°ƒ
> - å¯é€‰çš„é…ç½®é€‰é¡¹

```js
import { ref, watch } from 'vue'

const counter = ref(0)
counter.value = 5;
watch(counter, (newValue, oldValue) => {
  console.log('The new counter value is: ' + counter.value)
})
// ç›‘å¬å¤šä¸ªæ•°æ®
const data: IDataProps = reactive({
  count: 0,
  double: computed(() => data.count * 2),
  increase() {
    data.count++;
  },
});
watch([counter, data], (newV, oldV) => {
  console.log(newV, oldV); // oldVè¿”å›çš„æ˜¯Proxyï¼Œä¸å¥½å¤„ç†
})
watch([counter, () => data.count], (newV, oldV) => { // ç”¨å‡½æ•°æ”¹å†™æ¥è¿”å›å€¼
  console.log(newV, oldV);
})
```

#### 4. ç‹¬ç«‹çš„ `computed` å±æ€§

> ä¸ `ref` å’Œ `watch` ç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä» Vue å¯¼å…¥çš„ `computed` å‡½æ•°åœ¨ Vue ç»„ä»¶å¤–éƒ¨åˆ›å»ºè®¡ç®—å±æ€§ã€‚è®©æˆ‘ä»¬å›åˆ° counter çš„ä¾‹å­ï¼š

```js
import { ref, computed } from 'vue'

const counter = ref(0)
const twiceTheCounter = computed(() => counter.value * 2)

counter.value++
console.log(counter.value) // 1
console.log(twiceTheCounter.value) // 2
```

#### 5. è¿”å›æ¸²æŸ“å‡½æ•°

`setup` è¿˜å¯ä»¥è¿”å›ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥ç›´æ¥ä½¿ç”¨åœ¨åŒä¸€ä½œç”¨åŸŸä¸­å£°æ˜çš„å“åº”å¼çŠ¶æ€ï¼š

```js
// MyBook.vue

import { h, ref, reactive } from 'vue'

export default {
  setup() {
    const readersNumber = ref(0)
    const book = reactive({ title: 'Vue 3 Guide' })
    // è¯·æ³¨æ„è¿™é‡Œæˆ‘ä»¬éœ€è¦æ˜¾å¼ä½¿ç”¨ ref çš„ value
    return () => h('div', [readersNumber.value, book.title])
  }
}
```

è¿”å›ä¸€ä¸ªæ¸²æŸ“å‡½æ•°å°†é˜»æ­¢æˆ‘ä»¬è¿”å›ä»»ä½•å…¶å®ƒçš„ä¸œè¥¿ã€‚ä»å†…éƒ¨æ¥è¯´è¿™ä¸åº”è¯¥æˆä¸ºä¸€ä¸ªé—®é¢˜ï¼Œä½†å½“æˆ‘ä»¬æƒ³è¦å°†è¿™ä¸ªç»„ä»¶çš„æ–¹æ³•é€šè¿‡æ¨¡æ¿ ref æš´éœ²ç»™çˆ¶ç»„ä»¶æ—¶å°±ä¸ä¸€æ ·äº†ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ **`expose`** æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»™å®ƒä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­å®šä¹‰çš„ property å°†å¯ä»¥è¢«å¤–éƒ¨ç»„ä»¶å®ä¾‹è®¿é—®ï¼š

```js
import { h, ref } from 'vue'
export default {
  setup(props, { expose }) {
    const count = ref(0)
    const increment = () => ++count.value

    expose({
      increment
    })

    return () => h('div', count.value)
  }
}

```

è¿™ä¸ª `increment` æ–¹æ³•ç°åœ¨å°†å¯ä»¥é€šè¿‡çˆ¶ç»„ä»¶çš„æ¨¡æ¿ ref è®¿é—®ã€‚

#### 6. setup å†…çš„ç”Ÿå‘½å‘¨æœŸé’©å­( ä»£æ›¿ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸé’©å­ )

> ç»„åˆå¼ API ä¸Šçš„ç”Ÿå‘½å‘¨æœŸé’©å­ä¸é€‰é¡¹å¼ API çš„åç§°ç›¸åŒï¼Œä½†å‰ç¼€ä¸º **`on`**ï¼šå³ **`mounted`** çœ‹èµ·æ¥ä¼šåƒ **`onMounted`**
>
> è¿™äº›å‡½æ•°æ¥å—ä¸€ä¸ªå›è°ƒï¼Œå½“é’©å­è¢«ç»„ä»¶è°ƒç”¨æ—¶ï¼Œè¯¥å›è°ƒå°†è¢«æ‰§è¡Œ	

```js
import { onMounted } from 'vue'
```

| é€‰é¡¹å¼ API        | `setup` å†…çš„é’©å­                                             |
| :---------------- | ------------------------------------------------------------ |
| `beforeCreate`    | **Not needed**                                               |
| `created`         | **Not needed**                                               |
| `beforeMount`     | `onBeforeMount`                                              |
| `mounted`         | `onMounted`                                                  |
| `beforeUpdate`    | `onBeforeUpdate ` ï¼šdataé€‰é¡¹ä¸­æ•°æ®æ›´æ–°                       |
| `updated`         | `onUpdated` ï¼šdataé€‰é¡¹ä¸­æ•°æ®æ›´æ–°                             |
| `beforeUnmount`   | `onBeforeUnmount`                                            |
| `unmounted`       | `onUnmounted`                                                |
| `errorCaptured`   | `onErrorCaptured`                                            |
| `renderTracked`   | `onRenderTracked `ï¼šè°ƒè¯•ç”¨çš„debugé’©å­å‡½æ•°                    |
| `renderTriggered` | `onRenderTriggered((event) => {})`ï¼šè°ƒè¯•ç”¨çš„debugé’©å­å‡½æ•°ï¼Œdataé€‰é¡¹ä¸­çš„æ•°æ®æ›´æ–°æ—¶ï¼Œä¼šæ˜¾ç¤ºæ•°æ®å˜åŒ–çš„çŠ¶æ€ä¿¡æ¯ |
| `activated`       | `onActivated`                                                |
| `deactivated`     | `onDeactivated`                                              |

**æ³¨æ„ğŸ“¢ï¼š** <u>å› ä¸º `setup` æ˜¯å›´ç»• `beforeCreate` å’Œ `created` ç”Ÿå‘½å‘¨æœŸé’©å­è¿è¡Œçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æ˜¾å¼åœ°å®šä¹‰å®ƒä»¬ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨è¿™äº›é’©å­ä¸­ç¼–å†™çš„ä»»ä½•ä»£ç éƒ½åº”è¯¥ç›´æ¥åœ¨ `setup` å‡½æ•°ä¸­ç¼–å†™</u>

è¿™äº›å‡½æ•°**æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°**ï¼Œå½“é’©å­è¢«ç»„ä»¶è°ƒç”¨æ—¶å°†ä¼šè¢«æ‰§è¡Œ:

```js
export default {
  setup() {
    onMounted(() => {
      console.log('Component is mounted!')
    })
  }
}
```

#### 7. ä½¿ç”¨ Provideã€inject

> **`provide`** å‡½æ•°å…è®¸ä½ é€šè¿‡ä¸¤ä¸ªå‚æ•°å®šä¹‰ propertyï¼š
>
> 1. name (`<String>` ç±»å‹)
> 2. value
>
> **`inject`** å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼š
>
> 1. è¦ inject çš„ property çš„ name
> 2. é»˜è®¤å€¼ (**å¯é€‰**)

```vue
<!-- src/components/MyMap.vue -->
<template>
  <MyMarker />
</template>

<script>
import { provide, reactive, ref, readonly } from 'vue'
import MyMarker from './MyMarker.vue'

export default {
  components: {
    MyMarker
  },
  setup() {
    /* provide('location', 'North Pole')
    provide('geolocation', {
      longitude: 90,
      latitude: 135
    }) */
    
    // 1. ä¸ºäº†å¢åŠ  provide å€¼å’Œ inject å€¼ä¹‹é—´çš„å“åº”æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ provide å€¼æ—¶ä½¿ç”¨ ref æˆ– reactiveã€‚
    const location = ref('North Pole')
    const geolocation = reactive({
      longitude: 90,
      latitude: 135
    })
    provide('location', location)
    provide('geolocation', geolocation)
    
    // 2. å°½å¯èƒ½å°†å¯¹å“åº”å¼ property çš„æ‰€æœ‰ä¿®æ”¹é™åˆ¶åœ¨å®šä¹‰ provide çš„ç»„ä»¶å†…éƒ¨ã€‚
    // æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨æ³¨å…¥æ•°æ®çš„ç»„ä»¶å†…éƒ¨æ›´æ–° inject çš„æ•°æ®ã€‚
    // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å»ºè®® provide ä¸€ä¸ªæ–¹æ³•æ¥è´Ÿè´£æ”¹å˜å“åº”å¼ propertyã€‚
    const updateLocation = () => {
      location.value = 'South Pole'
    }
    provide('updateLocation', updateLocation)

    // 3. å¦‚æœè¦ç¡®ä¿é€šè¿‡ provide ä¼ é€’çš„æ•°æ®ä¸ä¼šè¢« inject çš„ç»„ä»¶æ›´æ”¹ï¼Œå»ºè®®å¯¹æä¾›è€…çš„ property ä½¿ç”¨ readonlyã€‚
    provide('location', readonly(location))
    provide('geolocation', readonly(geolocation))
    provide('updateLocation', updateLocation)
    
  },
  methods: {
    // å°½å¯èƒ½å°†å¯¹å“åº”å¼ property çš„æ‰€æœ‰ä¿®æ”¹é™åˆ¶åœ¨å®šä¹‰ provide çš„ç»„ä»¶å†…éƒ¨ã€‚
    updateLocation() { 
      this.location = 'South Pole'
    }
  }
}
</script>
```

```vue
<!-- src/components/MyMarker.vue -->
<script>
import { inject } from 'vue'

export default {
  setup() {
    const userLocation = inject('location', 'The Universe')
    const userGeolocation = inject('geolocation')
    const updateUserLocation = inject('updateLocation')

    return {
      userLocation,
      userGeolocation,
      updateUserLocation
    }
  }
}
</script>
```

#### 8. æ¨¡æ¿å¼•ç”¨

åœ¨ä½¿ç”¨ç»„åˆå¼ API æ—¶ï¼Œ[å“åº”å¼å¼•ç”¨](https://v3.cn.vuejs.org/guide/reactivity-fundamentals.html#åˆ›å»ºç‹¬ç«‹çš„å“åº”å¼å€¼ä½œä¸º-refs)å’Œ[æ¨¡æ¿å¼•ç”¨](https://v3.cn.vuejs.org/guide/component-template-refs.html)çš„æ¦‚å¿µæ˜¯ç»Ÿä¸€çš„ã€‚ä¸ºäº†è·å¾—å¯¹æ¨¡æ¿å†…å…ƒç´ æˆ–ç»„ä»¶å®ä¾‹çš„å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¾€å¸¸ä¸€æ ·å£°æ˜ ref å¹¶ä» [setup()](https://v3.cn.vuejs.org/guide/composition-api-setup.html) è¿”å›ï¼š

```vue
<template> 
  <div ref="root">This is a root element</div>
</template>
<script>
  import { ref, onMounted } from 'vue'
  export default {
    setup() {
      const root = ref(null)
      onMounted(() => {
        // DOM å…ƒç´ å°†åœ¨åˆå§‹æ¸²æŸ“ååˆ†é…ç»™ ref
        console.log(root.value) // <div>This is a root element</div>
      })
      return {
        root
      }
    }
  }
</script>
```

è¿™é‡Œæˆ‘ä»¬åœ¨æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­æš´éœ² `root`ï¼Œå¹¶é€šè¿‡ `ref="root"`ï¼Œå°†å…¶ç»‘å®šåˆ° div ä½œä¸ºå…¶ refã€‚åœ¨è™šæ‹Ÿ DOM è¡¥ä¸ç®—æ³•ä¸­ï¼Œå¦‚æœ VNode çš„ `ref` é”®å¯¹åº”äºæ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­çš„ refï¼Œåˆ™ VNode çš„ç›¸åº”å…ƒç´ æˆ–ç»„ä»¶å®ä¾‹å°†è¢«åˆ†é…ç»™è¯¥ ref çš„å€¼ã€‚è¿™æ˜¯åœ¨è™šæ‹Ÿ DOM æŒ‚è½½/æ‰“è¡¥ä¸è¿‡ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå› æ­¤æ¨¡æ¿å¼•ç”¨åªä¼šåœ¨åˆå§‹æ¸²æŸ“ä¹‹åè·å¾—èµ‹å€¼ã€‚

ä½œä¸ºæ¨¡æ¿ä½¿ç”¨çš„ ref çš„è¡Œä¸ºä¸ä»»ä½•å…¶ä»– ref ä¸€æ ·ï¼šå®ƒä»¬æ˜¯å“åº”å¼çš„ï¼Œå¯ä»¥ä¼ é€’åˆ° (æˆ–ä»ä¸­è¿”å›) å¤åˆå‡½æ•°ä¸­ã€‚

##### JSX ä¸­çš„ç”¨æ³•

```js
export default {
  setup() {
    const root = ref(null)
    return () =>
      h('div', {
        ref: root
      })
    // with JSX
    return () => <div ref={root} />
  }
}
```

##### `v-for` ä¸­çš„ç”¨æ³•

ç»„åˆå¼ API æ¨¡æ¿å¼•ç”¨åœ¨ `v-for` å†…éƒ¨ä½¿ç”¨æ—¶æ²¡æœ‰ç‰¹æ®Šå¤„ç†ã€‚ç›¸åï¼Œè¯·ä½¿ç”¨å‡½æ•°å¼•ç”¨æ‰§è¡Œè‡ªå®šä¹‰å¤„ç†ï¼š

```vue
<template>
  <div v-for="(item, i) in list" :ref="el => { if (el) divs[i] = el }">
    {{ item }}
  </div>
</template>
<script>
  import { ref, reactive, onBeforeUpdate } from 'vue'
  export default {
    setup() {
      const list = reactive([1, 2, 3])
      const divs = ref([])
      // ç¡®ä¿åœ¨æ¯æ¬¡æ›´æ–°ä¹‹å‰é‡ç½®ref
      onBeforeUpdate(() => {
        divs.value = []
      })
      return {
        list,
        divs
      }
    }
  }
</script>
```

##### ä¾¦å¬æ¨¡æ¿å¼•ç”¨

ä¾¦å¬æ¨¡æ¿å¼•ç”¨çš„å˜æ›´å¯ä»¥æ›¿ä»£å‰é¢ä¾‹å­ä¸­æ¼”ç¤ºä½¿ç”¨çš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚

ä½†ä¸ç”Ÿå‘½å‘¨æœŸé’©å­çš„ä¸€ä¸ªå…³é”®åŒºåˆ«æ˜¯ï¼Œ**`watch()`** å’Œ **`watchEffect()`** åœ¨ DOM æŒ‚è½½æˆ–æ›´æ–°*ä¹‹å‰*è¿è¡Œå‰¯ä½œç”¨ï¼Œæ‰€ä»¥å½“ä¾¦å¬å™¨è¿è¡Œæ—¶ï¼Œæ¨¡æ¿å¼•ç”¨è¿˜æœªè¢«æ›´æ–°ã€‚

```vue
<template>
  <div ref="root">This is a root element</div>
</template>
<script>
  import { ref, watchEffect } from 'vue'
  export default {
    setup() {
      const root = ref(null)
      
      watchEffect(() => {
        // è¿™ä¸ªå‰¯ä½œç”¨åœ¨ DOM æ›´æ–°ä¹‹å‰è¿è¡Œï¼Œå› æ­¤ï¼Œæ¨¡æ¿å¼•ç”¨è¿˜æ²¡æœ‰æŒæœ‰å¯¹å…ƒç´ çš„å¼•ç”¨ã€‚
        console.log(root.value) // => null
      })
      
      // ä½¿ç”¨æ¨¡æ¿å¼•ç”¨çš„ä¾¦å¬å™¨åº”è¯¥ç”¨ flush: 'post' é€‰é¡¹æ¥å®šä¹‰ï¼Œ
      // è¿™å°†åœ¨ DOM æ›´æ–°åè¿è¡Œå‰¯ä½œç”¨ï¼Œç¡®ä¿æ¨¡æ¿å¼•ç”¨ä¸ DOM ä¿æŒåŒæ­¥ï¼Œå¹¶å¼•ç”¨æ­£ç¡®çš„å…ƒç´ ã€‚
      watchEffect(() => {
        console.log(root.value) // => <div>This is a root element</div>
      }, 
      {
        flush: 'post'
      })
      
      return {
        root
      }
    }
  }
</script>
```



### Composition APIå’ŒOptions API(vue2.xä¸­çš„ä½¿ç”¨æ–¹å¼)çš„æ··åˆä½¿ç”¨

```vue
<script>
    export default{
        data(){
            return{}
        },
        methods:{},
        setup(){
            // æœ¬è´¨ä¸Šsetupä¸­å®šä¹‰çš„æ•°æ®ä¼šè¢«æ³¨å…¥åˆ°dataã€methodsä¸­
            return {...};
        }
    }
</script>
```

### Composition API çš„ä¼˜ç‚¹

1. **æ›´çµæ´»çš„é€»è¾‘ç»„ç»‡ã€æŠ½è±¡ã€å¤ç”¨èƒ½åŠ›**
2. **æ²¡æœ‰this**
3. **æ›´å¥½çš„ç±»å‹æ¨å¯¼èƒ½åŠ›ï¼ˆTypeScriptï¼‰**
4. **æ›´å‹å¥½çš„ `Tree-shaking`æ”¯æŒï¼Œæ¸è¿›å¼ä½“éªŒ**
5. **æ›´å¤§çš„ä»£ç å‹ç¼©ç©ºé—´**
