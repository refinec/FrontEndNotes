## Context è·¨å±‚ç»„ä»¶é€šä¿¡

> Context æä¾›äº†ä¸€ä¸ªæ— éœ€ä¸ºæ¯å±‚ç»„ä»¶æ‰‹åŠ¨æ·»åŠ  `props`ï¼Œå°±èƒ½åœ¨ç»„ä»¶æ ‘é—´è¿›è¡Œæ•°æ®ä¼ é€’çš„æ–¹æ³•

éœ€è¦ä½¿ç”¨çš„å·¥å…·ï¼š

* `React.createContext`
* ``Context.Provider`
* `Context.Consumer`
* ``Class.contextType`
* `Context.displayName`

### 1. `React.createContext`

```jsx
const MyContext = React.createContext(defaultValue);
```

åˆ›å»ºä¸€ä¸ª Context å¯¹è±¡ã€‚å½“ React æ¸²æŸ“ä¸€ä¸ªè®¢é˜…äº†è¿™ä¸ª Context å¯¹è±¡çš„ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶ä¼šä»ç»„ä»¶æ ‘ä¸­ç¦»è‡ªèº«æœ€è¿‘çš„é‚£ä¸ªåŒ¹é…çš„ `Provider` ä¸­è¯»å–åˆ°å½“å‰çš„ context å€¼ã€‚

**åªæœ‰**å½“ç»„ä»¶æ‰€å¤„çš„æ ‘ä¸­æ²¡æœ‰åŒ¹é…åˆ° Provider æ—¶ï¼Œå…¶ `defaultValue` å‚æ•°æ‰ä¼šç”Ÿæ•ˆã€‚æ­¤é»˜è®¤å€¼æœ‰åŠ©äºåœ¨ä¸ä½¿ç”¨ Provider åŒ…è£…ç»„ä»¶çš„æƒ…å†µä¸‹å¯¹ç»„ä»¶è¿›è¡Œæµ‹è¯•ã€‚æ³¨æ„ï¼šå°† `undefined` ä¼ é€’ç»™ Provider çš„ value æ—¶ï¼Œæ¶ˆè´¹ç»„ä»¶çš„ `defaultValue` ä¸ä¼šç”Ÿæ•ˆã€‚

### 2. `Context.Provider`

```jsx
// æ¯ä¸ª Context å¯¹è±¡éƒ½ä¼šè¿”å›ä¸€ä¸ª Provider React ç»„ä»¶ï¼Œå®ƒå…è®¸æ¶ˆè´¹ç»„ä»¶è®¢é˜… context çš„å˜åŒ–ã€‚
<MyContext.Provider value={/* æŸä¸ªå€¼ */}>
```

Provider æ¥æ”¶ä¸€ä¸ª `value` å±æ€§ï¼Œä¼ é€’ç»™æ¶ˆè´¹ç»„ä»¶ã€‚ä¸€ä¸ª Provider å¯ä»¥å’Œå¤šä¸ªæ¶ˆè´¹ç»„ä»¶æœ‰å¯¹åº”å…³ç³»ã€‚å¤šä¸ª Provider ä¹Ÿå¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œé‡Œå±‚çš„ä¼šè¦†ç›–å¤–å±‚çš„æ•°æ®ã€‚

å½“ Provider çš„ `value` å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå†…éƒ¨çš„æ‰€æœ‰æ¶ˆè´¹ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚ä» Provider åˆ°å…¶å†…éƒ¨ consumer ç»„ä»¶ï¼ˆåŒ…æ‹¬ [.contextType](https://zh-hans.reactjs.org/docs/context.html#classcontexttype) å’Œ [useContext](https://zh-hans.reactjs.org/docs/hooks-reference.html#usecontext)ï¼‰çš„ä¼ æ’­ä¸å—åˆ¶äº `shouldComponentUpdate` å‡½æ•°ï¼Œå› æ­¤å½“ consumer ç»„ä»¶åœ¨å…¶ç¥–å…ˆç»„ä»¶è·³è¿‡æ›´æ–°çš„æƒ…å†µä¸‹ä¹Ÿèƒ½æ›´æ–°ã€‚

#### æ³¨æ„ğŸ“¢ï¼š

å› ä¸º context ä¼šæ ¹æ®å¼•ç”¨æ ‡è¯†æ¥å†³å®šä½•æ—¶è¿›è¡Œæ¸²æŸ“ï¼ˆæœ¬è´¨ä¸Šæ˜¯ `value` å±æ€§å€¼çš„æµ…æ¯”è¾ƒï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½å­˜åœ¨ä¸€äº›é™·é˜±ï¼Œå½“ provider çš„çˆ¶ç»„ä»¶è¿›è¡Œé‡æ¸²æŸ“æ—¶ï¼Œå¯èƒ½ä¼šåœ¨ consumers ç»„ä»¶ä¸­è§¦å‘æ„å¤–çš„æ¸²æŸ“ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå½“æ¯ä¸€æ¬¡ Provider é‡æ¸²æŸ“æ—¶ï¼Œç”±äº `value` å±æ€§æ€»æ˜¯è¢«èµ‹å€¼ä¸ºæ–°çš„å¯¹è±¡ï¼Œä»¥ä¸‹çš„ä»£ç ä¼šé‡æ–°æ¸²æŸ“ä¸‹é¢æ‰€æœ‰çš„ consumers ç»„ä»¶ï¼š

```jsx
class App extends React.Component {
  render() {
    return (
      <MyContext.Provider value={{something: 'something'}}>
        <Toolbar />
      </MyContext.Provider>
    );
  }
}
```

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œå°† value çŠ¶æ€æå‡åˆ°çˆ¶èŠ‚ç‚¹çš„ `state` é‡Œï¼š

```jsx
class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      value: {something: 'something'},    };
  }

  render() {
    return (
      <MyContext.Provider value={this.state.value}>
        <Toolbar />
      </MyContext.Provider>
    );
  }
}
```

### 3. `Class.contextType`

```jsx
class MyClass extends React.Component {
  componentDidMount() {
    let value = this.context;
    /* åœ¨ç»„ä»¶æŒ‚è½½å®Œæˆåï¼Œä½¿ç”¨ MyContext ç»„ä»¶çš„å€¼æ¥æ‰§è¡Œä¸€äº›æœ‰å‰¯ä½œç”¨çš„æ“ä½œ */
  }
  componentDidUpdate() {
    let value = this.context;
    /* ... */
  }
  componentWillUnmount() {
    let value = this.context;
    /* ... */
  }
  render() {
    let value = this.context;
    /* åŸºäº MyContext ç»„ä»¶çš„å€¼è¿›è¡Œæ¸²æŸ“ */
  }
}
MyClass.contextType = MyContext;
```

æŒ‚è½½åœ¨ class ä¸Šçš„ `contextType` å±æ€§å¯ä»¥èµ‹å€¼ä¸ºç”± [`React.createContext()`](https://zh-hans.reactjs.org/docs/context.html#reactcreatecontext) åˆ›å»ºçš„ Context å¯¹è±¡ã€‚

å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ `static` è¿™ä¸ªç±»å±æ€§æ¥åˆå§‹åŒ–ä½ çš„ `contextType:`:

```jsx
class MyClass extends React.Component {
  static contextType = MyContext;
  render() {
    let value = this.context;
    /* åŸºäºè¿™ä¸ªå€¼è¿›è¡Œæ¸²æŸ“å·¥ä½œ */
  }
}
```

æ­¤å±æ€§å¯ä»¥è®©ä½ ä½¿ç”¨ `this.context` æ¥è·å–æœ€è¿‘ Context ä¸Šçš„å€¼ã€‚ä½ å¯ä»¥åœ¨ä»»ä½•ç”Ÿå‘½å‘¨æœŸä¸­è®¿é—®åˆ°å®ƒï¼ŒåŒ…æ‹¬ render å‡½æ•°ä¸­ã€‚

### 4. `Context.Consumer`

> è¯¥ç»„ä»¶è®©ä¸€ä¸ª React ç»„ä»¶å¯ä»¥è®¢é˜… context çš„å˜æ›´ï¼Œæ­¤ç»„ä»¶å¯ä»¥è®©ä½ åœ¨[å‡½æ•°å¼ç»„ä»¶](https://zh-hans.reactjs.org/docs/components-and-props.html#function-and-class-components)ä¸­å¯ä»¥è®¢é˜… contextã€‚

```jsx
import React from 'react';

const App = () => {
  return (
    <MyContext.Consumer>
      {ctx => {
        /* åŸºäº context å€¼è¿›è¡Œæ¸²æŸ“*/
        return (<div> {ctx.xxx} </div>)
      }}
    </MyContext.Consumer>
  )
}
export default App;
```

æ³¨æ„ğŸ“¢ï¼š`Context.Consumer`ç»„ä»¶éœ€è¦ä¸€ä¸ª[å‡½æ•°ä½œä¸ºå­å…ƒç´ ï¼ˆfunction as a childï¼‰](https://zh-hans.reactjs.org/docs/render-props.html#using-props-other-than-render)ï¼Œå¹¶æŠŠå½“å‰çš„ context å€¼ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª React èŠ‚ç‚¹ã€‚ä¼ é€’ç»™å‡½æ•°çš„ `ctx` å€¼ç­‰ä»·äºç»„ä»¶æ ‘ä¸Šæ–¹ç¦»è¿™ä¸ª context æœ€è¿‘çš„ Provider æä¾›çš„ `value` å€¼ã€‚å¦‚æœæ²¡æœ‰å¯¹åº”çš„ Providerï¼Œ`ctx` å‚æ•°ç­‰åŒäºä¼ é€’ç»™ `createContext()` çš„ `defaultValue`ã€‚

### 5. `Context.displayName`

context å¯¹è±¡æ¥å—ä¸€ä¸ªåä¸º `displayName` çš„ propertyï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚React DevTools ä½¿ç”¨è¯¥å­—ç¬¦ä¸²æ¥ç¡®å®š context è¦æ˜¾ç¤ºçš„å†…å®¹ã€‚

ç¤ºä¾‹ï¼Œä¸‹è¿°ç»„ä»¶åœ¨ DevTools ä¸­å°†æ˜¾ç¤ºä¸º **MyDisplayName**ï¼š

```jsx
const MyContext = React.createContext(/* some value */);
MyContext.displayName = 'MyDisplayName';
<MyContext.Provider> // "MyDisplayName.Provider" åœ¨ DevTools ä¸­
<MyContext.Consumer> // "MyDisplayName.Consumer" åœ¨ DevTools ä¸­
```

## ç¤ºä¾‹

### åŠ¨æ€ Context

```js
// theme-context.js
export const themes = {
  light: {
    foreground: '#000000',
    background: '#eeeeee',
  },
  dark: {
    foreground: '#ffffff',
    background: '#222222',
  },
};

export const ThemeContext = React.createContext(
  themes.dark // é»˜è®¤å€¼
);
```

```js
// themed-button.js
import {ThemeContext} from './theme-context';

class ThemedButton extends React.Component {
  render() {
    let props = this.props;
    let theme = this.context;
    return (
      <button
        {...props}
        style={{backgroundColor: theme.background}}
      />
    );
  }
}
ThemedButton.contextType = ThemeContext;

export default ThemedButton;
```

```js
// app.js
import {ThemeContext, themes} from './theme-context';
import ThemedButton from './themed-button';

// ä¸€ä¸ªä½¿ç”¨ ThemedButton çš„ä¸­é—´ç»„ä»¶
function Toolbar(props) {
  return (
    <ThemedButton onClick={props.changeTheme}>
      Change Theme
    </ThemedButton>
  );
}

class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      theme: themes.light,
    };

    this.toggleTheme = () => {
      this.setState(state => ({
        theme:
          state.theme === themes.dark
            ? themes.light
            : themes.dark,
      }));
    };
  }

  render() {
    // åœ¨ ThemeProvider å†…éƒ¨çš„ ThemedButton æŒ‰é’®ç»„ä»¶ä½¿ç”¨ state ä¸­çš„ theme å€¼ï¼Œ
    // è€Œå¤–éƒ¨çš„ç»„ä»¶ä½¿ç”¨é»˜è®¤çš„ theme å€¼
    return (
      <Page>
        <ThemeContext.Provider value={this.state.theme}>
          <Toolbar changeTheme={this.toggleTheme} />
        </ThemeContext.Provider>
        <Section>
          <ThemedButton />
        </Section>
      </Page>
    );
  }
}

const root = ReactDOM.createRoot(
  document.getElementById('root')
);
root.render(<App />);
```

### åœ¨åµŒå¥—ç»„ä»¶ä¸­æ›´æ–° Context

ä»ä¸€ä¸ªåœ¨ç»„ä»¶æ ‘ä¸­åµŒå¥—å¾ˆæ·±çš„ç»„ä»¶ä¸­æ›´æ–° context æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡ context ä¼ é€’ä¸€ä¸ªå‡½æ•°ï¼Œä½¿å¾— consumers ç»„ä»¶æ›´æ–° contextï¼š

```js
// theme-context.js
// ç¡®ä¿ä¼ é€’ç»™ createContext çš„é»˜è®¤å€¼æ•°æ®ç»“æ„æ˜¯è°ƒç”¨çš„ç»„ä»¶ï¼ˆconsumersï¼‰æ‰€èƒ½åŒ¹é…çš„ï¼
export const ThemeContext = React.createContext({
  theme: themes.dark,
  toggleTheme: () => {},
});
```

```js
// theme-toggler-button.js
import {ThemeContext} from './theme-context';

function ThemeTogglerButton() {
  // Theme Toggler æŒ‰é’®ä¸ä»…ä»…åªè·å– theme å€¼ï¼Œ
  // å®ƒä¹Ÿä» context ä¸­è·å–åˆ°ä¸€ä¸ª toggleTheme å‡½æ•°
  return (
    <ThemeContext.Consumer>
      {({theme, toggleTheme}) => (
        <button
          onClick={toggleTheme}
          style={{backgroundColor: theme.background}}>
          Toggle Theme
        </button>
      )}
    </ThemeContext.Consumer>
  );
}

export default ThemeTogglerButton;
```

```js
// app.js
import {ThemeContext, themes} from './theme-context';
import ThemeTogglerButton from './theme-toggler-button';

class App extends React.Component {
  constructor(props) {
    super(props);

    this.toggleTheme = () => {
      this.setState(state => ({
        theme:
          state.theme === themes.dark
            ? themes.light
            : themes.dark,
      }));
    };

    // State ä¹ŸåŒ…å«äº†æ›´æ–°å‡½æ•°ï¼Œå› æ­¤å®ƒä¼šè¢«ä¼ é€’è¿› context providerã€‚
    this.state = {
      theme: themes.light,
      toggleTheme: this.toggleTheme,
    };
  }

  render() {
    // æ•´ä¸ª state éƒ½è¢«ä¼ é€’è¿› provider
    return (
      <ThemeContext.Provider value={this.state}>
        <Content />
      </ThemeContext.Provider>
    );
  }
}

function Content() {
  return (
    <div>
      <ThemeTogglerButton />
    </div>
  );
}

const root = ReactDOM.createRoot(
  document.getElementById('root')
);
root.render(<App />);
```

### æ¶ˆè´¹å¤šä¸ª Context

ä¸ºäº†ç¡®ä¿ context å¿«é€Ÿè¿›è¡Œé‡æ¸²æŸ“ï¼ŒReact éœ€è¦ä½¿æ¯ä¸€ä¸ª consumers ç»„ä»¶çš„ context åœ¨ç»„ä»¶æ ‘ä¸­æˆä¸ºä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ã€‚

```jsx
// Theme contextï¼Œé»˜è®¤çš„ theme æ˜¯ â€œlightâ€ å€¼
const ThemeContext = React.createContext('light');

// ç”¨æˆ·ç™»å½• context
const UserContext = React.createContext({
  name: 'Guest',
});

class App extends React.Component {
  render() {
    const {signedInUser, theme} = this.props;

    // æä¾›åˆå§‹ context å€¼çš„ App ç»„ä»¶
    return (
      <ThemeContext.Provider value={theme}>
        <UserContext.Provider value={signedInUser}>
          <Layout />
        </UserContext.Provider>
      </ThemeContext.Provider>
    );
  }
}

function Layout() {
  return (
    <div>
      <Sidebar />
      <Content />
    </div>
  );
}

// ä¸€ä¸ªç»„ä»¶å¯èƒ½ä¼šæ¶ˆè´¹å¤šä¸ª context
function Content() {
  return (
    <ThemeContext.Consumer>
      {theme => (
        <UserContext.Consumer>
          {user => (
            <ProfilePage user={user} theme={theme} />
          )}
        </UserContext.Consumer>
      )}
    </ThemeContext.Consumer>
  );
}
```

å¦‚æœä¸¤ä¸ªæˆ–è€…æ›´å¤šçš„ context å€¼ç»å¸¸è¢«ä¸€èµ·ä½¿ç”¨ï¼Œé‚£ä½ å¯èƒ½è¦è€ƒè™‘ä¸€ä¸‹å¦å¤–åˆ›å»ºä½ è‡ªå·±çš„æ¸²æŸ“ç»„ä»¶ï¼Œä»¥æä¾›è¿™äº›å€¼ã€‚