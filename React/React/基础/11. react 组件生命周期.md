# react ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ

**å¸¸ç”¨ç”Ÿå‘½å‘¨æœŸå›¾è°±ï¼š**

![image-20220812181235316](../../../assets/react/image-20220812181235316.png)

**å±•ç¤ºä¸å¸¸ç”¨ç”Ÿå‘½å‘¨æœŸå›¾è°±ï¼š**

![image-20220812181353550](../../../assets/react/image-20220812181353550.png)

## æŒ‚è½½

å½“ç»„ä»¶å®ä¾‹è¢«åˆ›å»ºå¹¶æ’å…¥ DOM ä¸­æ—¶ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸè°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š

1. **`constructor()`**
2. `static getDerivedStateFromProps()`
3. **`render()`**
4. **`componentDidMount()`**

### 1. constructor(props)

```jsx
constructor(props) {
  super(props);
  // ä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ this.setState()
  this.state = { counter: 0 };
  this.handleClick = this.handleClick.bind(this);
}
```

**æ³¨æ„ğŸ“¢**ï¼š

- **å¦‚æœä¸åˆå§‹åŒ– `state` æˆ–ä¸è¿›è¡Œ`æ–¹æ³•ç»‘å®š`ï¼Œåˆ™ä¸éœ€è¦ä¸º React ç»„ä»¶å®ç°æ„é€ å‡½æ•°**

- åœ¨ React ç»„ä»¶æŒ‚è½½ä¹‹å‰ï¼Œä¼šè°ƒç”¨å®ƒçš„æ„é€ å‡½æ•°ã€‚åœ¨ä¸º `React.Component` å­ç±»å®ç°æ„é€ å‡½æ•°æ—¶ï¼Œåº”åœ¨å…¶ä»–è¯­å¥ä¹‹å‰è°ƒç”¨ `super(props)`ã€‚å¦åˆ™ï¼Œ`this.props` åœ¨æ„é€ å‡½æ•°ä¸­å¯èƒ½ä¼šå‡ºç°æœªå®šä¹‰çš„ bugã€‚

- **é¿å…å°† props çš„å€¼å¤åˆ¶ç»™ state**ï¼Œå› ä¸ºè¿™ä¹ˆåšæ¯«æ— å¿…è¦ï¼ŒåŒæ—¶è¿˜äº§ç”Ÿäº† bugï¼ˆæ›´æ–° prop ä¸­çš„ `color` æ—¶ï¼Œå¹¶ä¸ä¼šå½±å“ stateï¼‰ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ `this.props.color`

   ```jsx
   constructor(props) {
    super(props);
    // ä¸è¦è¿™æ ·åš
    this.state = { color: props.color };
   }
   ```

### 3. render()

> `render()` æ–¹æ³•æ˜¯ class ç»„ä»¶ä¸­å”¯ä¸€ä¸€ä¸ªå¿…é¡»å®ç°çš„æ–¹æ³•ã€‚

å½“ `render` è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ `this.props` å’Œ `this.state` çš„å˜åŒ–å¹¶è¿”å›ä»¥ä¸‹ç±»å‹ä¹‹ä¸€ï¼š

* **React å…ƒç´ **

* **æ•°ç»„æˆ– fragments**

  ä½¿å¾— render æ–¹æ³•å¯ä»¥è¿”å›å¤šä¸ªå…ƒç´ ã€‚ğŸ‘‰ğŸ»å‚é˜… [fragments](https://zh-hans.reactjs.org/docs/fragments.html) æ–‡æ¡£

* **Portals**

  å¯ä»¥æ¸²æŸ“å­èŠ‚ç‚¹åˆ°ä¸åŒçš„ DOM å­æ ‘ä¸­ã€‚ğŸ‘‰ğŸ»å‚é˜… [portals](https://zh-hans.reactjs.org/docs/portals.html) æ–‡æ¡£

* **å­—ç¬¦ä¸²æˆ–æ•°å€¼ç±»å‹**

  å®ƒä»¬åœ¨ DOM ä¸­ä¼šè¢«æ¸²æŸ“ä¸ºæ–‡æœ¬èŠ‚ç‚¹ã€‚

* **å¸ƒå°”ç±»å‹æˆ– `null`**ã€‚

  ä»€ä¹ˆéƒ½ä¸æ¸²æŸ“ã€‚ï¼ˆä¸»è¦ç”¨äºæ”¯æŒè¿”å› `test && <Child />` çš„æ¨¡å¼ï¼Œå…¶ä¸­ test ä¸ºå¸ƒå°”ç±»å‹ã€‚)

**æ³¨æ„ğŸ“¢**ï¼š

- `render()` å‡½æ•°åº”è¯¥ä¸ºçº¯å‡½æ•°ï¼Œè¿™æ„å‘³ç€åœ¨ä¸ä¿®æ”¹ç»„ä»¶ state çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¿”å›ç›¸åŒçš„ç»“æœï¼Œå¹¶ä¸”å®ƒä¸ä¼šç›´æ¥ä¸æµè§ˆå™¨äº¤äº’ã€‚

- å¦‚éœ€ä¸æµè§ˆå™¨è¿›è¡Œäº¤äº’ï¼Œè¯·åœ¨ `componentDidMount()` æˆ–å…¶ä»–ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­æ‰§è¡Œä½ çš„æ“ä½œã€‚
- å¦‚æœ `shouldComponentUpdate()` è¿”å› **false**ï¼Œåˆ™ä¸ä¼šè°ƒç”¨ `render()`ã€‚

### 4. componentDidMount() ç»„ä»¶æŒ‚è½½

> `componentDidMount()` ä¼šåœ¨ç»„ä»¶æŒ‚è½½åï¼ˆæ’å…¥ DOM æ ‘ä¸­ï¼‰ç«‹å³è°ƒç”¨ã€‚

#### ç”¨å¤„

1. ç½‘ç»œè¯·æ±‚è·å–æ•°æ®
2. è·å–DOMèŠ‚ç‚¹
3. é€‚åˆæ·»åŠ è®¢é˜…ï¼ˆå¦‚æœæ·»åŠ äº†è®¢é˜…ï¼Œä¸è¦å¿˜è®°åœ¨ `componentWillUnmount()` é‡Œå–æ¶ˆè®¢é˜…ï¼‰

## æ›´æ–°

å½“ç»„ä»¶çš„ **props** æˆ– **state** å‘ç”Ÿå˜åŒ–æ—¶ä¼šè§¦å‘æ›´æ–°ã€‚ç»„ä»¶æ›´æ–°çš„ç”Ÿå‘½å‘¨æœŸè°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š

1. `static getDerivedStateFromProps()`
2. `shouldComponentUpdate()`
3. **`render()`**
4. `getSnapshotBeforeUpdate()`
5. **`componentDidUpdate()`**

### 1. static getDerivedStateFromProps(`props`, `state`)

> `getDerivedStateFromProps` ä¼šåœ¨è°ƒç”¨ render æ–¹æ³•ä¹‹å‰è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨åˆå§‹æŒ‚è½½åŠåç»­æ›´æ–°æ—¶éƒ½ä¼šè¢«è°ƒç”¨ã€‚å®ƒåº”è¿”å›ä¸€ä¸ªå¯¹è±¡æ¥æ›´æ–° stateï¼Œå¦‚æœè¿”å› `null` åˆ™ä¸æ›´æ–°ä»»ä½•å†…å®¹ã€‚

#### ä½¿ç”¨åœºæ™¯

æ­¤æ–¹æ³•é€‚ç”¨äº[ç½•è§çš„ç”¨ä¾‹](https://zh-hans.reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html#when-to-use-derived-state)ï¼Œå³ state çš„å€¼åœ¨ä»»ä½•æ—¶å€™éƒ½å–å†³äº propsã€‚ä¾‹å¦‚ï¼Œå®ç° `<Transition>` ç»„ä»¶å¯èƒ½å¾ˆæ–¹ä¾¿ï¼Œè¯¥ç»„ä»¶ä¼šæ¯”è¾ƒå½“å‰ç»„ä»¶ä¸ä¸‹ä¸€ç»„ä»¶ï¼Œä»¥å†³å®šé’ˆå¯¹å“ªäº›ç»„ä»¶è¿›è¡Œè½¬åœºåŠ¨ç”»ã€‚

**æ³¨æ„ğŸ“¢ï¼š**

æ´¾ç”ŸçŠ¶æ€ä¼šå¯¼è‡´ä»£ç å†—ä½™ï¼Œå¹¶ä½¿ç»„ä»¶éš¾ä»¥ç»´æŠ¤ã€‚ [ç¡®ä¿ä½ å·²ç†Ÿæ‚‰è¿™äº›ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼š](https://zh-hans.reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html)

- å¦‚æœä½ éœ€è¦**æ‰§è¡Œå‰¯ä½œç”¨**ï¼ˆä¾‹å¦‚ï¼Œæ•°æ®æå–æˆ–åŠ¨ç”»ï¼‰ä»¥å“åº” props ä¸­çš„æ›´æ”¹ï¼Œè¯·æ”¹ç”¨ [`componentDidUpdate`](https://zh-hans.reactjs.org/docs/react-component.html#componentdidupdate)ã€‚
- å¦‚æœåªæƒ³åœ¨ **prop æ›´æ”¹æ—¶é‡æ–°è®¡ç®—æŸäº›æ•°æ®**ï¼Œ[è¯·ä½¿ç”¨ memoization helper ä»£æ›¿](https://zh-hans.reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html#what-about-memoization)ã€‚
- å¦‚æœä½ æƒ³**åœ¨ prop æ›´æ”¹æ—¶â€œé‡ç½®â€æŸäº› state**ï¼Œè¯·è€ƒè™‘ä½¿ç»„ä»¶[å®Œå…¨å—æ§](https://zh-hans.reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html#recommendation-fully-controlled-component)æˆ–[ä½¿ç”¨ `key` ä½¿ç»„ä»¶å®Œå…¨ä¸å—æ§](https://zh-hans.reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html#recommendation-fully-uncontrolled-component-with-a-key) ä»£æ›¿ã€‚

æ­¤æ–¹æ³•æ— æƒè®¿é—®ç»„ä»¶å®ä¾‹ã€‚å¦‚æœä½ éœ€è¦ï¼Œå¯ä»¥é€šè¿‡æå–ç»„ä»¶ props çš„çº¯å‡½æ•°åŠ class ä¹‹å¤–çš„çŠ¶æ€ï¼Œåœ¨`getDerivedStateFromProps()`å’Œå…¶ä»– class æ–¹æ³•ä¹‹é—´é‡ç”¨ä»£ç ã€‚

è¯·æ³¨æ„ï¼Œä¸ç®¡åŸå› æ˜¯ä»€ä¹ˆï¼Œéƒ½ä¼šåœ¨*æ¯æ¬¡*æ¸²æŸ“å‰è§¦å‘æ­¤æ–¹æ³•ã€‚è¿™ä¸ `UNSAFE_componentWillReceiveProps` å½¢æˆå¯¹æ¯”ï¼Œåè€…ä»…åœ¨çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶è§¦å‘ï¼Œè€Œä¸æ˜¯åœ¨å†…éƒ¨è°ƒç”¨ `setState` æ—¶ã€‚

### 2. shouldComponentUpdate(`nextProps`, `nextState`)

> ğŸ“¢ï¼šè¯¥æ–¹æ³•è¯·ä»…åœ¨éœ€è¦**[æ€§èƒ½ä¼˜åŒ–](https://zh-hans.reactjs.org/docs/optimizing-performance.html)**çš„æ—¶å€™ä½¿ç”¨
>
> æ¯æ¬¡å½“ `props` æˆ– `state` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œ`shouldComponentUpdate()` ä¼šåœ¨æ¸²æŸ“æ‰§è¡Œä¹‹å‰è¢«è°ƒç”¨ã€‚è¿”å›å€¼é»˜è®¤ä¸º **true**ï¼ˆ`true`ï¼šé‡æ–°æ¸²æŸ“ï¼Œ`false`ï¼šä¸é‡æ–°æ¸²æŸ“ï¼‰

### å¦‚ä½•ä½¿ç”¨ï¼Ÿ

> å°† `this.props` ä¸ `nextProps` ä»¥åŠ `this.state` ä¸`nextState` è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶è¿”å› `false` ä»¥å‘ŠçŸ¥ React å¯ä»¥è·³è¿‡æ›´æ–°ã€‚è¯·æ³¨æ„ï¼Œè¿”å› `false` å¹¶ä¸ä¼šé˜»æ­¢**<u>å­ç»„ä»¶</u>**åœ¨ `state` æ›´æ”¹æ—¶é‡æ–°æ¸²æŸ“ã€‚

ç›®å‰ï¼Œå¦‚æœ `shouldComponentUpdate()` è¿”å› `false`ï¼Œåˆ™ä¸ä¼šè°ƒç”¨ [`UNSAFE_componentWillUpdate()`](https://zh-hans.reactjs.org/docs/react-component.html#unsafe_componentwillupdate)ï¼Œ[`render()`](https://zh-hans.reactjs.org/docs/react-component.html#render) å’Œ [`componentDidUpdate()`](https://zh-hans.reactjs.org/docs/react-component.html#componentdidupdate)ã€‚åç»­ç‰ˆæœ¬ï¼ŒReact å¯èƒ½ä¼šå°† `shouldComponentUpdate` è§†ä¸ºæç¤ºè€Œä¸æ˜¯ä¸¥æ ¼çš„æŒ‡ä»¤ï¼Œå¹¶ä¸”ï¼Œå½“è¿”å› `false` æ—¶ï¼Œä»å¯èƒ½å¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

#### ä»€ä¹ˆæƒ…å†µä¸‹ä¸è¢«è°ƒç”¨ï¼Ÿ

1. é¦–æ¬¡æ¸²æŸ“
2. ä½¿ç”¨ `forceUpdate()` æ—¶

**æ³¨æ„ğŸ“¢ï¼š**

1. æˆ‘ä»¬ä¸å»ºè®®åœ¨ `shouldComponentUpdate()` ä¸­è¿›è¡Œæ·±å±‚æ¯”è¾ƒæˆ–ä½¿ç”¨ `JSON.stringify()`ã€‚è¿™æ ·éå¸¸å½±å“æ•ˆç‡ï¼Œä¸”ä¼šæŸå®³æ€§èƒ½ã€‚

2. ä¸è¦ä¼å›¾ä¾é æ­¤æ–¹æ³•æ¥â€œé˜»æ­¢â€æ¸²æŸ“ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šäº§ç”Ÿ bugã€‚

   ä½ åº”è¯¥**è€ƒè™‘ä½¿ç”¨å†…ç½®çš„ [`PureComponent`](https://zh-hans.reactjs.org/docs/react-api.html#reactpurecomponent) ç»„ä»¶**ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ç¼–å†™ `shouldComponentUpdate()`ã€‚`PureComponent` ä¼šå¯¹ **`props`** å’Œ **`state`** è¿›è¡Œæµ…å±‚æ¯”è¾ƒï¼Œå¹¶å‡å°‘äº†è·³è¿‡å¿…è¦æ›´æ–°çš„å¯èƒ½æ€§ã€‚

### 4. getSnapshotBeforeUpdate(`prevProps`, `prevState`)

> `getSnapshotBeforeUpdate()` åœ¨æœ€è¿‘ä¸€æ¬¡æ¸²æŸ“è¾“å‡ºï¼ˆæäº¤åˆ° DOM èŠ‚ç‚¹ï¼‰ä¹‹å‰è°ƒç”¨ã€‚
>
> å®ƒä½¿å¾—ç»„ä»¶èƒ½åœ¨å‘ç”Ÿæ›´æ”¹ä¹‹å‰ä» DOM ä¸­æ•è·ä¸€äº›ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œæ»šåŠ¨ä½ç½®ï¼‰ã€‚æ­¤ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„ä»»ä½•è¿”å›å€¼å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `componentDidUpdate()`ã€‚

#### ä½¿ç”¨åœºæ™¯

1. å¯èƒ½å‡ºç°åœ¨ UI å¤„ç†ä¸­
2. éœ€è¦ä»¥ç‰¹æ®Šæ–¹å¼å¤„ç†æ»šåŠ¨ä½ç½®çš„èŠå¤©çº¿ç¨‹ç­‰ã€‚

**åº”è¿”å› `snapshot` çš„å€¼ï¼ˆæˆ– `null`ï¼‰**ã€‚

```jsx
class ScrollingList extends React.Component {
  constructor(props) {
    super(props);
    this.listRef = React.createRef();
  }

  getSnapshotBeforeUpdate(prevProps, prevState) {
    // æˆ‘ä»¬æ˜¯å¦åœ¨ list ä¸­æ·»åŠ æ–°çš„ items ï¼Ÿ
    // æ•è·æ»šåŠ¨â€‹â€‹ä½ç½®ä»¥ä¾¿æˆ‘ä»¬ç¨åè°ƒæ•´æ»šåŠ¨ä½ç½®ã€‚
    if (prevProps.list.length < this.props.list.length) {
      const list = this.listRef.current;
      return list.scrollHeight - list.scrollTop;
    }
    return null;
  }

  componentDidUpdate(prevProps, prevState, snapshot) {
    // å¦‚æœæˆ‘ä»¬ snapshot æœ‰å€¼ï¼Œè¯´æ˜æˆ‘ä»¬åˆšåˆšæ·»åŠ äº†æ–°çš„ itemsï¼Œ
    // è°ƒæ•´æ»šåŠ¨ä½ç½®ä½¿å¾—è¿™äº›æ–° items ä¸ä¼šå°†æ—§çš„ items æ¨å‡ºè§†å›¾ã€‚
    //ï¼ˆè¿™é‡Œçš„ snapshot æ˜¯ getSnapshotBeforeUpdate çš„è¿”å›å€¼ï¼‰
    if (snapshot !== null) {
      const list = this.listRef.current;
      list.scrollTop = list.scrollHeight - snapshot;
    }
  }

  render() {
    return (
      <div ref={this.listRef}>{/* ...contents... */}</div>
    );
  }
}
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œé‡ç‚¹æ˜¯ä» `getSnapshotBeforeUpdate` è¯»å– `scrollHeight` å±æ€§ï¼Œå› ä¸º â€œrenderâ€ é˜¶æ®µç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚ `render`ï¼‰å’Œ â€œcommitâ€ é˜¶æ®µç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚ `getSnapshotBeforeUpdate` å’Œ `componentDidUpdate`ï¼‰ä¹‹é—´å¯èƒ½å­˜åœ¨å»¶è¿Ÿã€‚

### 5. componentDidUpdate(`prevProps`, `prevState`, `snapshot`) ç»„ä»¶æ›´æ–°

> `componentDidUpdate()` ä¼šåœ¨æ›´æ–°åä¼šè¢«ç«‹å³è°ƒç”¨ï¼Œé¦–æ¬¡æ¸²æŸ“ä¸ä¼šæ‰§è¡Œæ­¤æ–¹æ³•ã€‚

**ç¬¬ä¸‰å‚æ•°**(`snapshot`)ï¼šå¦‚æœç»„ä»¶å®ç°äº† `getSnapshotBeforeUpdate()` ç”Ÿå‘½å‘¨æœŸï¼ˆä¸å¸¸ç”¨ï¼‰ï¼Œåˆ™å®ƒçš„è¿”å›å€¼å°†ä½œä¸º `componentDidUpdate()` çš„ç¬¬ä¸‰ä¸ªå‚æ•° â€œ`snapshot`â€ å‚æ•°ä¼ é€’ã€‚å¦åˆ™æ­¤å‚æ•°å°†ä¸º **`undefined`**ã€‚

### ç”¨å¤„

1. **DOMæ“ä½œ**ï¼ˆå½“ç»„ä»¶æ›´æ–°åï¼Œå¯ä»¥åœ¨æ­¤å¤„å¯¹ DOM è¿›è¡Œæ“ä½œï¼‰

2. **ç½‘ç»œè¯·æ±‚**ï¼ˆå¦‚æœä½ å¯¹æ›´æ–°å‰åçš„ **props** è¿›è¡Œäº†æ¯”è¾ƒï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨æ­¤å¤„è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼‰

   ```jsx
   componentDidUpdate(prevProps) {
     // å…¸å‹ç”¨æ³•ï¼ˆä¸è¦å¿˜è®°æ¯”è¾ƒ propsï¼‰ï¼š
     if (this.props.userID !== prevProps.userID) {
       this.fetchData(this.props.userID);
     }
   }
   ```

**æ³¨æ„ğŸ“¢**ï¼š

- åœ¨ `componentDidUpdate()` ä¸­**ç›´æ¥è°ƒç”¨ `setState()`**æ—¶ï¼Œè¦æ³¨æ„**å®ƒå¿…é¡»è¢«åŒ…è£¹åœ¨ä¸€ä¸ªæ¡ä»¶è¯­å¥é‡Œ**ï¼Œæ­£å¦‚ä¸Šè¿°çš„ä¾‹å­é‚£æ ·è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œå®ƒè¿˜ä¼šå¯¼è‡´é¢å¤–çš„é‡æ–°æ¸²æŸ“ï¼Œè™½ç„¶ç”¨æˆ·ä¸å¯è§ï¼Œä½†ä¼šå½±å“ç»„ä»¶æ€§èƒ½ã€‚
- å¦‚æœ [`shouldComponentUpdate()`](https://zh-hans.reactjs.org/docs/react-component.html#shouldcomponentupdate) è¿”å›å€¼ä¸º falseï¼Œåˆ™ä¸ä¼šè°ƒç”¨ `componentDidUpdate()`

## å¸è½½

å½“ç»„ä»¶ä» DOM ä¸­ç§»é™¤æ—¶ä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š

1. **`componentWillUnmount()`**

### componentWillUnmount()

> `componentWillUnmount()` ä¼šåœ¨ç»„ä»¶å¸è½½åŠé”€æ¯ä¹‹å‰ç›´æ¥è°ƒç”¨ã€‚
>
> åœ¨æ­¤æ–¹æ³•ä¸­æ‰§è¡Œå¿…è¦çš„æ¸…ç†æ“ä½œã€‚

#### ç”¨å¤„

1. æ¸…é™¤ **timer**
2. å–æ¶ˆç½‘ç»œè¯·æ±‚
3. æ¸…é™¤åœ¨ `componentDidMount()` ä¸­åˆ›å»ºçš„è®¢é˜…ç­‰

**æ³¨æ„ğŸ“¢**ï¼š

- `componentWillUnmount()` ä¸­**ä¸åº”è°ƒç”¨ `setState()`**ï¼Œå› ä¸ºè¯¥ç»„ä»¶å°†æ°¸è¿œä¸ä¼šé‡æ–°æ¸²æŸ“ï¼ˆç»„ä»¶å®ä¾‹å¸è½½åï¼Œå°†æ°¸è¿œä¸ä¼šå†æŒ‚è½½å®ƒï¼‰



## é”™è¯¯å¤„ç†

> [Error boundaries](https://zh-hans.reactjs.org/docs/error-boundaries.html) æ˜¯ React ç»„ä»¶ï¼Œå®ƒä¼šåœ¨å…¶å­ç»„ä»¶æ ‘ä¸­çš„ä»»ä½•ä½ç½®æ•è· JavaScript é”™è¯¯ï¼Œå¹¶è®°å½•è¿™äº›é”™è¯¯ï¼Œå±•ç¤ºé™çº§ UI è€Œä¸æ˜¯å´©æºƒçš„ç»„ä»¶æ ‘ã€‚
>
> Error boundaries ç»„ä»¶ä¼šæ•è·**åœ¨æ¸²æŸ“æœŸé—´**ï¼Œ**åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•**ä»¥åŠå…¶æ•´ä¸ªæ ‘çš„**æ„é€ å‡½æ•°**ä¸­å‘ç”Ÿçš„é”™è¯¯ã€‚

> å¦‚æœ class ç»„ä»¶å®šä¹‰äº†ç”Ÿå‘½å‘¨æœŸæ–¹æ³• `static getDerivedStateFromError()` æˆ– `componentDidCatch()` ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼ˆæˆ–ä¸¤è€…ï¼‰ï¼Œå®ƒå°±æˆä¸ºäº† **Error boundaries**ã€‚
>
> é€šè¿‡ç”Ÿå‘½å‘¨æœŸæ›´æ–° `state` å¯è®©ç»„ä»¶æ•è·æ ‘ä¸­æœªå¤„ç†çš„ JavaScript é”™è¯¯å¹¶å±•ç¤ºé™çº§ UIã€‚

> ä»…ä½¿ç”¨ **Error boundaries** ç»„ä»¶æ¥ä»æ„å¤–å¼‚å¸¸ä¸­æ¢å¤çš„æƒ…å†µï¼›**ä¸è¦å°†å®ƒä»¬ç”¨äºæµç¨‹æ§åˆ¶ã€‚**å‚é˜… [*React 16 ä¸­çš„é”™è¯¯å¤„ç†*](https://zh-hans.reactjs.org/blog/2017/07/26/error-handling-in-react-16.html)ã€‚
>
> **Error boundaries** ä»…æ•è·ç»„ä»¶æ ‘ä¸­`static getDerivedStateFromError()`å’Œ`componentDidCatch()`ç»„ä»¶ä¸­çš„é”™è¯¯ã€‚ä½†å®ƒæœ¬èº«çš„é”™è¯¯æ— æ³•æ•è·ã€‚



å½“æ¸²æŸ“è¿‡ç¨‹ï¼Œç”Ÿå‘½å‘¨æœŸï¼Œæˆ–å­ç»„ä»¶çš„æ„é€ å‡½æ•°ä¸­æŠ›å‡ºé”™è¯¯æ—¶ï¼Œä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š

- `static getDerivedStateFromError()`
- `componentDidCatch()`

### static getDerivedStateFromError(`error`)

> æ­¤ç”Ÿå‘½å‘¨æœŸä¼šåœ¨åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯åè¢«è°ƒç”¨ã€‚ 
> å®ƒå°†æŠ›å‡ºçš„é”™è¯¯ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼ä»¥æ›´æ–° `state`

```jsx
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    // æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“å¯ä»¥æ˜¾é™çº§ UI
    return { hasError: true };
  }

  render() {
    if (this.state.hasError) {
      // ä½ å¯ä»¥æ¸²æŸ“ä»»ä½•è‡ªå®šä¹‰çš„é™çº§  UI
      return <h1>Something went wrong.</h1>;
    }

    return this.props.children;
  }
}
```

**æ³¨æ„ğŸ“¢ï¼š**

`getDerivedStateFromError()` ä¼šåœ¨`æ¸²æŸ“`é˜¶æ®µè°ƒç”¨ï¼Œå› æ­¤ä¸å…è®¸å‡ºç°å‰¯ä½œç”¨ã€‚ å¦‚é‡æ­¤ç±»æƒ…å†µï¼Œè¯·æ”¹ç”¨ `componentDidCatch()`

### componentDidCatch(`error`, `info`)

æ­¤ç”Ÿå‘½å‘¨æœŸåœ¨åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯åè¢«è°ƒç”¨ã€‚ å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š

1. `error` â€”â€” æŠ›å‡ºçš„é”™è¯¯ã€‚
2. `info` â€”â€” å¸¦æœ‰ `componentStack` key çš„å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«[æœ‰å…³ç»„ä»¶å¼•å‘é”™è¯¯çš„æ ˆä¿¡æ¯](https://zh-hans.reactjs.org/docs/error-boundaries.html#component-stack-traces)ã€‚

`componentDidCatch()` ä¼šåœ¨â€œæäº¤â€é˜¶æ®µè¢«è°ƒç”¨ï¼Œå› æ­¤å…è®¸æ‰§è¡Œå‰¯ä½œç”¨ã€‚ å®ƒåº”è¯¥ç”¨äºè®°å½•é”™è¯¯ä¹‹ç±»çš„æƒ…å†µï¼š

```jsx
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    // æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“å¯ä»¥æ˜¾ç¤ºé™çº§ UI
    return { hasError: true };
  }

  componentDidCatch(error, info) {
    // "ç»„ä»¶å †æ ˆ" ä¾‹å­:
    //   in ComponentThatThrows (created by App)
    //   in ErrorBoundary (created by App)
    //   in div (created by App)
    //   in App
    logComponentStackToMyService(info.componentStack);
  }

  render() {
    if (this.state.hasError) {
      // ä½ å¯ä»¥æ¸²æŸ“ä»»ä½•è‡ªå®šä¹‰çš„é™çº§ UI
      return <h1>Something went wrong.</h1>;
    }

    return this.props.children;
  }
}
```

**æ³¨æ„ğŸ“¢ï¼š**

React çš„å¼€å‘å’Œç”Ÿäº§æ„å»ºç‰ˆæœ¬åœ¨ `componentDidCatch()` çš„æ–¹å¼ä¸Šæœ‰è½»å¾®å·®åˆ«ã€‚

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œé”™è¯¯ä¼šå†’æ³¡è‡³ `window`ï¼Œè¿™æ„å‘³ç€ä»»ä½• `window.onerror` æˆ– `window.addEventListener('error', callback)` ä¼šä¸­æ–­è¿™äº›å·²ç»è¢« `componentDidCatch()` æ•è·çš„é”™è¯¯ã€‚

ç›¸åï¼Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œé”™è¯¯ä¸ä¼šå†’æ³¡ï¼Œè¿™æ„å‘³ç€ä»»ä½•æ ¹é”™è¯¯å¤„ç†å™¨åªä¼šæ¥å—é‚£äº›æ²¡æœ‰æ˜¾å¼åœ°è¢« `componentDidCatch()` æ•è·çš„é”™è¯¯ã€‚

å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨ `setState` ä½¿ç”¨ `componentDidCatch()` æ¸²æŸ“é™çº§ UIï¼Œä½†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å°†ä¸æ¨èè¿™æ ·åšã€‚ å¯ä»¥ä½¿ç”¨é™æ€ `getDerivedStateFromError()` æ¥å¤„ç†é™çº§æ¸²æŸ“ã€‚

# å…¶ä»– APIs

ä¸åŒäºä¸Šè¿°ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆReact ä¸»åŠ¨è°ƒç”¨ï¼‰ï¼Œä»¥ä¸‹æ–¹æ³•æ˜¯ä½ å¯ä»¥åœ¨ç»„ä»¶ä¸­è°ƒç”¨çš„æ–¹æ³•ï¼š

- `setState()`
- `forceUpdate()`

### setState(updater[, callback])

> `setState()` å¹¶ä¸æ€»æ˜¯ç«‹å³æ›´æ–°ç»„ä»¶ï¼Œå®ƒä¼šæ‰¹é‡æ¨è¿Ÿæ›´æ–°ï¼ˆä¸ºäº†æ›´å¥½çš„æ„ŸçŸ¥æ€§èƒ½ï¼ŒReact ä¼šå»¶è¿Ÿè°ƒç”¨å®ƒï¼Œç„¶åé€šè¿‡ä¸€æ¬¡ä¼ é€’æ›´æ–°å¤šä¸ªç»„ä»¶ï¼‰ã€‚
>
> åœ¨ç½•è§çš„æƒ…å†µä¸‹ï¼Œä½ éœ€è¦å¼ºåˆ¶ DOM æ›´æ–°åŒæ­¥åº”ç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ [`flushSync`](https://zh-hans.reactjs.org/docs/react-dom.html#flushsync) æ¥åŒ…è£…å®ƒï¼Œä½†è¿™å¯èƒ½ä¼šæŸå®³æ€§èƒ½

è¿™ä½¿å¾—åœ¨è°ƒç”¨ `setState()` åç«‹å³è¯»å– `this.state` æˆä¸ºäº†éšæ‚£ã€‚ä¸ºäº†æ¶ˆé™¤éšæ‚£ï¼Œè¯·ä½¿ç”¨ `componentDidUpdate` æˆ–è€… `setState` çš„å›è°ƒå‡½æ•°ï¼ˆ`setState(updater, callback)`ï¼‰ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ä¿è¯åœ¨åº”ç”¨æ›´æ–°åè§¦å‘ã€‚

é™¤é `shouldComponentUpdate()` è¿”å› `false`ï¼Œå¦åˆ™ `setState()` å°†å§‹ç»ˆæ‰§è¡Œé‡æ–°æ¸²æŸ“æ“ä½œã€‚å¦‚æœå¯å˜å¯¹è±¡è¢«ä½¿ç”¨ï¼Œä¸”æ— æ³•åœ¨ `shouldComponentUpdate()` ä¸­å®ç°æ¡ä»¶æ¸²æŸ“ï¼Œé‚£ä¹ˆä»…åœ¨æ–°æ—§çŠ¶æ€ä¸ä¸€æ—¶è°ƒç”¨ `setState()`å¯ä»¥é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ï¼š

- [State å’Œç”Ÿå‘½å‘¨æœŸæŒ‡å—](https://zh-hans.reactjs.org/docs/state-and-lifecycle.html)
- [æ·±å…¥å­¦ä¹ ï¼šä½•æ—¶ä»¥åŠä¸ºä»€ä¹ˆ `setState()` ä¼šæ‰¹é‡æ‰§è¡Œï¼Ÿ](https://stackoverflow.com/a/48610973/458193)
- [æ·±å…¥ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥æ›´æ–° `this.state`ï¼Ÿ](https://github.com/facebook/react/issues/11527#issuecomment-360199710)

#### å‚æ•°ä¸€(`updater`)

##### 1. å‡½æ•°å½¢å¼

æ ¼å¼ï¼š`(state, props) => stateChange`

`state` æ˜¯å¯¹åº”ç”¨å˜åŒ–æ—¶ç»„ä»¶çŠ¶æ€çš„å¼•ç”¨ï¼Œå®ƒä¸åº”ç›´æ¥è¢«ä¿®æ”¹ï¼Œä½ åº”è¯¥ä½¿ç”¨åŸºäº `state` å’Œ `props` æ„å»ºçš„æ–°å¯¹è±¡æ¥è¡¨ç¤ºå˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æ ¹æ® `props.step` æ¥å¢åŠ  stateï¼š

```jsx
this.setState((state, props) => {
  return {counter: state.counter + props.step};
});
```

updater å‡½æ•°ä¸­æ¥æ”¶çš„ `state` å’Œ `props` éƒ½ä¿è¯ä¸ºæœ€æ–°ã€‚updater çš„è¿”å›å€¼ä¼šä¸ `state` è¿›è¡Œæµ…åˆå¹¶ã€‚

##### 2.å¯¹è±¡å½¢å¼

æ ¼å¼ï¼š`setState(stateChange[, callback])`

`stateChange` ä¼šå°†ä¼ å…¥çš„å¯¹è±¡æµ…å±‚åˆå¹¶åˆ°æ–°çš„ state ä¸­ï¼Œä¾‹å¦‚ï¼Œè°ƒæ•´è´­ç‰©è½¦å•†å“æ•°ï¼š

```jsx
this.setState({quantity: 2})
```

è¿™ç§å½¢å¼çš„ `setState()` ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸”åœ¨åŒä¸€å‘¨æœŸå†…ä¼šå¯¹å¤šä¸ª `setState` è¿›è¡Œæ‰¹å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨åŒä¸€å‘¨æœŸå†…å¤šæ¬¡è®¾ç½®å•†å“æ•°é‡å¢åŠ ï¼Œåˆ™ç›¸å½“äºï¼š

```js
Object.assign(
  previousState,
  {quantity: state.quantity + 1},
  {quantity: state.quantity + 1},
  ...
)
```

åè°ƒç”¨çš„ `setState()` å°†è¦†ç›–åŒä¸€å‘¨æœŸå†…å…ˆè°ƒç”¨ `setState` çš„å€¼ï¼Œå› æ­¤å•†å“æ•°ä»…å¢åŠ ä¸€æ¬¡ã€‚å¦‚æœåç»­çŠ¶æ€å–å†³äºå½“å‰çŠ¶æ€ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ updater å‡½æ•°çš„å½¢å¼ä»£æ›¿ï¼š

```jsx
this.setState((state) => {
  return {quantity: state.quantity + 1};
});
```

#### å‚æ•°äºŒ(`callback`)

> `setState()` çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºå¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œå®ƒå°†åœ¨ `setState` å®Œæˆåˆå¹¶å¹¶é‡æ–°æ¸²æŸ“ç»„ä»¶åæ‰§è¡Œã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ `componentDidUpdate()` æ¥ä»£æ›¿æ­¤æ–¹å¼ã€‚

### component.forceUpdate(callback)

> é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ç»„ä»¶çš„ `state` æˆ– `props` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç»„ä»¶å°†é‡æ–°æ¸²æŸ“ã€‚å¦‚æœ `render()` æ–¹æ³•ä¾èµ–äºå…¶ä»–æ•°æ®ï¼Œåˆ™å¯ä»¥è°ƒç”¨ `forceUpdate()` å¼ºåˆ¶è®©ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

è°ƒç”¨ `forceUpdate()` å°†è‡´ä½¿ç»„ä»¶è°ƒç”¨ `render()` æ–¹æ³•ï¼Œæ­¤æ“ä½œä¼šè·³è¿‡è¯¥ç»„ä»¶çš„ `shouldComponentUpdate()`ã€‚ä½†å…¶å­ç»„ä»¶ä¼šè§¦å‘æ­£å¸¸çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ŒåŒ…æ‹¬ `shouldComponentUpdate()` æ–¹æ³•ã€‚å¦‚æœæ ‡è®°å‘ç”Ÿå˜åŒ–ï¼ŒReact ä»å°†åªæ›´æ–° DOMã€‚

é€šå¸¸ä½ åº”è¯¥é¿å…ä½¿ç”¨ `forceUpdate()`ï¼Œå°½é‡åœ¨ `render()` ä¸­ä½¿ç”¨ `this.props` å’Œ `this.state`ã€‚

# class å±æ€§

- `defaultProps`
- `displayName`

## defaultProps

> `defaultProps` å¯ä»¥ä¸º Class ç»„ä»¶æ·»åŠ é»˜è®¤ `props`ã€‚è¿™ä¸€èˆ¬ç”¨äº props æœªèµ‹å€¼ï¼Œä½†åˆä¸èƒ½ä¸º `null` çš„æƒ…å†µ

```jsx
class CustomButton extends React.Component {
  // ...
}

CustomButton.defaultProps = {
  color: 'blue'
};
```

å¦‚æœæœªæä¾› `props.color`ï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸º `'blue'`

```jsx
  render() {
    return <CustomButton /> ; // props.color å°†è®¾ç½®ä¸º 'blue'
  }
```

å¦‚æœ `props.color` è¢«è®¾ç½®ä¸º `null`ï¼Œåˆ™å®ƒå°†ä¿æŒä¸º `null`

```jsx
  render() {
    return <CustomButton color={null} /> ; // props.color å°†ä¿æŒæ˜¯ null
  }
```

## displayName

`displayName` å­—ç¬¦ä¸²å¤šç”¨äºè°ƒè¯•æ¶ˆæ¯ã€‚é€šå¸¸ï¼Œä½ ä¸éœ€è¦è®¾ç½®å®ƒï¼Œå› ä¸ºå®ƒå¯ä»¥æ ¹æ®å‡½æ•°ç»„ä»¶æˆ– class ç»„ä»¶çš„åç§°æ¨æ–­å‡ºæ¥ã€‚å¦‚æœè°ƒè¯•æ—¶éœ€è¦æ˜¾ç¤ºä¸åŒçš„åç§°æˆ–åˆ›å»ºé«˜é˜¶ç»„ä»¶ï¼Œè¯·å‚é˜…[ä½¿ç”¨ displayname è½»æ¾è¿›è¡Œè°ƒè¯•](https://zh-hans.reactjs.org/docs/higher-order-components.html#convention-wrap-the-display-name-for-easy-debugging)

