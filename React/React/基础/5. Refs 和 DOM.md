## Refs

### `React.forwardRef`è½¬å‘

> Ref è½¬å‘æ˜¯ä¸€é¡¹å°† [ref](https://zh-hans.reactjs.org/docs/refs-and-the-dom.html) è‡ªåŠ¨åœ°é€šè¿‡ç»„ä»¶ä¼ é€’åˆ°å…¶ä¸€å­ç»„ä»¶çš„æŠ€å·§ï¼ˆ**ä½¿ç”¨refæš´éœ²DOMèŠ‚ç‚¹ç»™çˆ¶ç»„ä»¶**ï¼‰

#### ç¤ºä¾‹

`FancyButton` ä½¿ç”¨ `React.forwardRef` æ¥è·å–ä¼ é€’ç»™å®ƒçš„ `ref`ï¼Œç„¶åè½¬å‘åˆ°å®ƒæ¸²æŸ“çš„ DOM `button`ï¼š

```jsx
// å­ç»„ä»¶
const FancyButton = React.forwardRef((props, ref) => (
  <button ref={ref} className="FancyButton">
    {props.children}
  </button>
));

// çˆ¶ç»„ä»¶
function App() {
  // ä½ å¯ä»¥ç›´æ¥è·å– DOM button çš„ refï¼š
	const ref = React.createRef();
	// æˆ–è€…
	// const ref = useRef(null);
	return (
  	<>
    	<FancyButton ref={ref}>Click me!</FancyButton>;
    </>
  )
}
```

è¿™æ ·ï¼Œä½¿ç”¨ `FancyButton` çš„ç»„ä»¶å¯ä»¥è·å–åº•å±‚ DOM èŠ‚ç‚¹ `button` çš„ ref ï¼Œå¹¶åœ¨å¿…è¦æ—¶è®¿é—®ï¼Œå°±åƒå…¶ç›´æ¥ä½¿ç”¨ DOM `button` ä¸€æ ·ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä¸Šè¿°ç¤ºä¾‹å‘ç”Ÿæƒ…å†µçš„é€æ­¥è§£é‡Šï¼š

1. æˆ‘ä»¬é€šè¿‡è°ƒç”¨ `React.createRef` æˆ–`useRef`åˆ›å»ºäº†ä¸€ä¸ª [React ref](https://zh-hans.reactjs.org/docs/refs-and-the-dom.html) å¹¶å°†å…¶èµ‹å€¼ç»™ `ref` å˜é‡ã€‚
2. æˆ‘ä»¬é€šè¿‡æŒ‡å®š `ref` ä¸º JSX å±æ€§ï¼Œå°†å…¶å‘ä¸‹ä¼ é€’ç»™ `<FancyButton ref={ref}>`ã€‚
3. React ä¼ é€’ `ref` ç»™ `forwardRef` å†…å‡½æ•° `(props, ref) => ...`ï¼Œä½œä¸ºå…¶ç¬¬äºŒä¸ªå‚æ•°ã€‚
4. æˆ‘ä»¬å‘ä¸‹è½¬å‘è¯¥ `ref` å‚æ•°åˆ° `<button ref={ref}>`ï¼Œå°†å…¶æŒ‡å®šä¸º JSX å±æ€§ã€‚
5. å½“ ref æŒ‚è½½å®Œæˆï¼Œ`ref.current` å°†æŒ‡å‘ `<button>` DOM èŠ‚ç‚¹ã€‚

### åœ¨é«˜é˜¶ç»„ä»¶ä¸­è½¬å‘ refs

è¿™ä¸ªæŠ€å·§å¯¹[é«˜é˜¶ç»„ä»¶](https://zh-hans.reactjs.org/docs/higher-order-components.html)ï¼ˆä¹Ÿè¢«ç§°ä¸º HOCï¼‰ç‰¹åˆ«æœ‰ç”¨ã€‚è®©æˆ‘ä»¬ä»ä¸€ä¸ªè¾“å‡ºç»„ä»¶ props åˆ°æ§åˆ¶å°çš„ HOC ç¤ºä¾‹å¼€å§‹ï¼š

```jsx
function logProps(WrappedComponent) {  
  class LogProps extends React.Component {
    componentDidUpdate(prevProps) {
      console.log('old props:', prevProps);
      console.log('new props:', this.props);
    }

    render() {
      return <WrappedComponent {...this.props} />;    }
  }

  return LogProps;
}
```



â€œlogPropsâ€ HOC é€ä¼ ï¼ˆpass throughï¼‰æ‰€æœ‰ `props` åˆ°å…¶åŒ…è£¹çš„ç»„ä»¶ï¼Œæ‰€ä»¥æ¸²æŸ“ç»“æœå°†æ˜¯ç›¸åŒçš„ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ HOC è®°å½•æ‰€æœ‰ä¼ é€’åˆ° â€œfancy buttonâ€ ç»„ä»¶çš„ propsï¼š

```jsx
class FancyButton extends React.Component {
  focus() {
    // ...
  }

  // ...
}

// æˆ‘ä»¬å¯¼å‡º LogPropsï¼Œè€Œä¸æ˜¯ FancyButtonã€‚
// è™½ç„¶å®ƒä¹Ÿä¼šæ¸²æŸ“ä¸€ä¸ª FancyButtonã€‚
export default logProps(FancyButton);
```



ä¸‹é¢çš„ç¤ºä¾‹æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šrefs å°†ä¸ä¼šé€ä¼ ä¸‹å»ã€‚è¿™æ˜¯å› ä¸º `ref` ä¸æ˜¯ prop å±æ€§ã€‚å°±åƒ `key` ä¸€æ ·ï¼Œå…¶è¢« React è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ã€‚å¦‚æœä½ å¯¹ HOC æ·»åŠ  refï¼Œè¯¥ ref å°†å¼•ç”¨æœ€å¤–å±‚çš„å®¹å™¨ç»„ä»¶ï¼Œè€Œä¸æ˜¯è¢«åŒ…è£¹çš„ç»„ä»¶ã€‚

è¿™æ„å‘³ç€ç”¨äºæˆ‘ä»¬ `FancyButton` ç»„ä»¶çš„ refs å®é™…ä¸Šå°†è¢«æŒ‚è½½åˆ° `LogProps` ç»„ä»¶ï¼š

```jsx
import FancyButton from './FancyButton';

const ref = React.createRef();
// æˆ‘ä»¬å¯¼å…¥çš„ FancyButton ç»„ä»¶æ˜¯é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰LogPropsã€‚
// å°½ç®¡æ¸²æŸ“ç»“æœå°†æ˜¯ä¸€æ ·çš„ï¼Œ
// ä½†æˆ‘ä»¬çš„ ref å°†æŒ‡å‘ LogProps è€Œä¸æ˜¯å†…éƒ¨çš„ FancyButton ç»„ä»¶ï¼
// è¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½è°ƒç”¨ä¾‹å¦‚ ref.current.focus() è¿™æ ·çš„æ–¹æ³•
<FancyButton
  label="Click Me"
  handleClick={handleClick}
  ref={ref}/>;
```



å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `React.forwardRef` API æ˜ç¡®åœ°å°† refs è½¬å‘åˆ°å†…éƒ¨çš„ `FancyButton` ç»„ä»¶ã€‚`React.forwardRef` æ¥å—ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œå…¶æ¥æ”¶ `props` å’Œ `ref` å‚æ•°å¹¶è¿”å›ä¸€ä¸ª React èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼š

```jsx
function logProps(Component) {
  class LogProps extends React.Component {
    componentDidUpdate(prevProps) {
      console.log('old props:', prevProps);
      console.log('new props:', this.props);
    }

    render() {
      const {forwardedRef, ...rest} = this.props;
      // å°†è‡ªå®šä¹‰çš„ prop å±æ€§ â€œforwardedRefâ€ å®šä¹‰ä¸º ref
      return <Component ref={forwardedRef} {...rest} />;    }
  }

  // æ³¨æ„ React.forwardRef å›è°ƒçš„ç¬¬äºŒä¸ªå‚æ•° â€œrefâ€ã€‚
  // æˆ‘ä»¬å¯ä»¥å°†å…¶ä½œä¸ºå¸¸è§„ prop å±æ€§ä¼ é€’ç»™ LogPropsï¼Œä¾‹å¦‚ â€œforwardedRefâ€
  // ç„¶åå®ƒå°±å¯ä»¥è¢«æŒ‚è½½åˆ°è¢« LogProps åŒ…è£¹çš„å­ç»„ä»¶ä¸Šã€‚
  return React.forwardRef((props, ref) => {    return <LogProps {...props} forwardedRef={ref} />;  });}
```

### åœ¨ DevTools ä¸­æ˜¾ç¤ºè‡ªå®šä¹‰åç§°

`React.forwardRef` æ¥å—ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ã€‚React DevTools ä½¿ç”¨è¯¥å‡½æ•°æ¥å†³å®šä¸º ref è½¬å‘ç»„ä»¶æ˜¾ç¤ºçš„å†…å®¹ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹ç»„ä»¶å°†åœ¨ DevTools ä¸­æ˜¾ç¤ºä¸º â€œ*ForwardRef*â€ï¼š

```jsx
const WrappedComponent = React.forwardRef((props, ref) => {
  return <LogProps {...props} forwardedRef={ref} />;
});
```

å¦‚æœä½ å‘½åäº†æ¸²æŸ“å‡½æ•°ï¼ŒDevTools ä¹Ÿå°†åŒ…å«å…¶åç§°ï¼ˆä¾‹å¦‚ â€œ*ForwardRef(myFunction)*â€ï¼‰ï¼š

```jsx
const WrappedComponent = React.forwardRef(
  function myFunction(props, ref) {
    return <LogProps {...props} forwardedRef={ref} />;
  }
);
```

ä½ ç”šè‡³å¯ä»¥è®¾ç½®å‡½æ•°çš„ `displayName` å±æ€§æ¥åŒ…å«è¢«åŒ…è£¹ç»„ä»¶çš„åç§°ï¼š

```jsx
function logProps(Component) {
  class LogProps extends React.Component {
    // ...
  }

  function forwardRef(props, ref) {
    return <LogProps {...props} forwardedRef={ref} />;
  }

  // åœ¨ DevTools ä¸­ä¸ºè¯¥ç»„ä»¶æä¾›ä¸€ä¸ªæ›´æœ‰ç”¨çš„æ˜¾ç¤ºåã€‚
  // ä¾‹å¦‚ â€œForwardRef(logProps(MyComponent))â€
  const name = Component.displayName || Component.name;  forwardRef.displayName = `logProps(${name})`;
  return React.forwardRef(forwardRef);
}
```

## Refs & DOM

> Refs æä¾›äº†ä¸€ç§æ–¹å¼ï¼Œå…è®¸æˆ‘ä»¬è®¿é—® **DOM èŠ‚ç‚¹**æˆ–åœ¨` render `æ–¹æ³•ä¸­åˆ›å»ºçš„ **React å…ƒç´ **

### é€‚åˆä½¿ç”¨ refs çš„ä¸‰ç§æƒ…å†µ

ä¸‹é¢æ˜¯å‡ ä¸ªé€‚åˆä½¿ç”¨ refs çš„æƒ…å†µï¼š

- ç®¡ç†ç„¦ç‚¹ï¼Œæ–‡æœ¬é€‰æ‹©æˆ–åª’ä½“æ’­æ”¾ã€‚
- è§¦å‘å¼ºåˆ¶åŠ¨ç”»ã€‚
- é›†æˆç¬¬ä¸‰æ–¹ DOM åº“ã€‚

é¿å…ä½¿ç”¨ refs æ¥åšä»»ä½•å¯ä»¥é€šè¿‡å£°æ˜å¼å®ç°æ¥å®Œæˆçš„äº‹æƒ…ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œé¿å…åœ¨ `Dialog` ç»„ä»¶é‡Œæš´éœ² `open()` å’Œ `close()` æ–¹æ³•ï¼Œæœ€å¥½ä¼ é€’ `isOpen` å±æ€§ã€‚

### å¦‚ä½•ä½¿ç”¨

#### ä¸€ã€`React.createRef()`

1. Refs æ˜¯ä½¿ç”¨ `React.createRef()` åˆ›å»ºçš„ï¼Œå¹¶é€šè¿‡ `ref` å±æ€§é™„åŠ åˆ° React å…ƒç´ ã€‚

   åœ¨æ„é€ ç»„ä»¶æ—¶ï¼Œé€šå¸¸å°† Refs åˆ†é…ç»™å®ä¾‹å±æ€§ï¼Œä»¥ä¾¿å¯ä»¥åœ¨æ•´ä¸ªç»„ä»¶ä¸­å¼•ç”¨å®ƒä»¬

2. å½“ ref è¢«ä¼ é€’ç»™ `render` ä¸­çš„å…ƒç´ æ—¶ï¼Œå¯¹è¯¥èŠ‚ç‚¹çš„å¼•ç”¨å¯ä»¥åœ¨ ref çš„ `current` å±æ€§ä¸­è¢«è®¿é—®

3. **ä¸èƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸Šä½¿ç”¨ `ref` å±æ€§**ï¼Œå› ä¸ºä»–ä»¬æ²¡æœ‰å®ä¾‹ã€‚å¦‚æœè¦åœ¨å‡½æ•°ç»„ä»¶ä¸­ä½¿ç”¨ `ref`ï¼Œä½ å¯ä»¥ä½¿ç”¨ [`forwardRef`](https://zh-hans.reactjs.org/docs/forwarding-refs.html)ï¼ˆå¯ä¸ [`useImperativeHandle`](https://zh-hans.reactjs.org/docs/hooks-reference.html#useimperativehandle) ç»“åˆä½¿ç”¨ï¼‰ï¼Œæˆ–è€…å¯ä»¥å°†è¯¥ç»„ä»¶è½¬åŒ–ä¸º `class` ç»„ä»¶ã€‚

   ```jsx
   function CustomTextInput(props) {
     // è¿™é‡Œå¿…é¡»å£°æ˜ textInputï¼Œè¿™æ · ref æ‰å¯ä»¥å¼•ç”¨å®ƒ
     const textInput = useRef(null);
   
     function handleClick() {
       textInput.current.focus();
     }
   
     return (
       <div>
         <input
           type="text"
           ref={textInput} />
         <input
           type="button"
           value="Focus the text input"
           onClick={handleClick}
         />
       </div>
     );
   }
   ```

```jsx
class CustomTextInput extends React.Component {
  constructor(props) {
    super(props);
    // åˆ›å»ºä¸€ä¸ª ref æ¥å­˜å‚¨ textInput çš„ DOM å…ƒç´ 
    this.textInput = React.createRef();
    this.focusTextInput = this.focusTextInput.bind(this);
  }

  focusTextInput() {
    // ç›´æ¥ä½¿ç”¨åŸç”Ÿ API ä½¿ text è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
    // æ³¨æ„ï¼šæˆ‘ä»¬é€šè¿‡ "current" æ¥è®¿é—® DOM èŠ‚ç‚¹
    this.textInput.current.focus();
  }

  render() {
    // å‘Šè¯‰ React æˆ‘ä»¬æƒ³æŠŠ <input> ref å…³è”åˆ°
    // æ„é€ å™¨é‡Œåˆ›å»ºçš„ `textInput` ä¸Š
    return (
      <div>
        <input
          type="text"
          ref={this.textInput} />
        <input
          type="button"
          value="Focus the text input"
          onClick={this.focusTextInput}
        />
      </div>
    );
  }
}
```

React ä¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶ç»™ `current` å±æ€§ä¼ å…¥ DOM å…ƒç´ ï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶ä¼ å…¥ `null` å€¼ã€‚

`ref` ä¼šåœ¨ `componentDidMount` æˆ– `componentDidUpdate` ç”Ÿå‘½å‘¨æœŸé’©å­è§¦å‘å‰æ›´æ–°ã€‚

#### äºŒã€å›è°ƒ Refs

> React æ”¯æŒå¦ä¸€ç§è®¾ç½® refs çš„æ–¹å¼ï¼Œç§°ä¸ºâ€œ**å›è°ƒ refs**â€ã€‚å®ƒèƒ½åŠ©ä½ æ›´ç²¾ç»†åœ°æ§åˆ¶ä½•æ—¶ refs è¢«è®¾ç½®å’Œè§£é™¤ã€‚
>
> ä¸åŒäºä¼ é€’ `createRef()` åˆ›å»ºçš„ `ref` å±æ€§ï¼Œä½ ä¼šä¼ é€’ä¸€ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¸­æ¥å— React ç»„ä»¶å®ä¾‹æˆ– HTML DOM å…ƒç´ ä½œä¸ºå‚æ•°ï¼Œä»¥ä½¿å®ƒä»¬èƒ½åœ¨å…¶ä»–åœ°æ–¹è¢«å­˜å‚¨å’Œè®¿é—®ã€‚

```jsx
class CustomTextInput extends React.Component {
  constructor(props) {
    super(props);

    this.textInput = null;

    this.setTextInputRef = element => {
      this.textInput = element;
    };

    this.focusTextInput = () => {
      // ä½¿ç”¨åŸç”Ÿ DOM API ä½¿ text è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
      if (this.textInput) this.textInput.focus();
    };
  }

  componentDidMount() {
    // ç»„ä»¶æŒ‚è½½åï¼Œè®©æ–‡æœ¬æ¡†è‡ªåŠ¨è·å¾—ç„¦ç‚¹
    this.focusTextInput();
  }

  render() {
    // ä½¿ç”¨ `ref` çš„å›è°ƒå‡½æ•°å°† text è¾“å…¥æ¡† DOM èŠ‚ç‚¹çš„å¼•ç”¨å­˜å‚¨åˆ° React
    // å®ä¾‹ä¸Šï¼ˆæ¯”å¦‚ this.textInputï¼‰
    return (
      <div>
        <input
          type="text"
          ref={this.setTextInputRef}
        />
        <input
          type="button"
          value="Focus the text input"
          onClick={this.focusTextInput}
        />
      </div>
    );
  }
}
```

> React å°†åœ¨ç»„ä»¶æŒ‚è½½æ—¶ï¼Œä¼šè°ƒç”¨ `ref` å›è°ƒå‡½æ•°å¹¶ä¼ å…¥ DOM å…ƒç´ ï¼Œå½“å¸è½½æ—¶è°ƒç”¨å®ƒå¹¶ä¼ å…¥ `null`ã€‚åœ¨ `componentDidMount` æˆ– `componentDidUpdate` è§¦å‘å‰ï¼ŒReact ä¼šä¿è¯ refs ä¸€å®šæ˜¯æœ€æ–°çš„

```jsx
function CustomTextInput(props) {
  return (
    <div>
      <input ref={props.inputRef} />
    </div>
  );
}

class Parent extends React.Component {
  render() {
    return (
      <CustomTextInput
        inputRef={el => this.inputElement = el}
      />
    );
  }
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`Parent` æŠŠå®ƒçš„ refs å›è°ƒå‡½æ•°å½“ä½œ `inputRef` props ä¼ é€’ç»™äº† `CustomTextInput`ï¼Œè€Œä¸” `CustomTextInput` æŠŠç›¸åŒçš„å‡½æ•°ä½œä¸ºç‰¹æ®Šçš„ `ref` å±æ€§ä¼ é€’ç»™äº† `<input>`ã€‚ç»“æœæ˜¯ï¼Œåœ¨ `Parent` ä¸­çš„ `this.inputElement` ä¼šè¢«è®¾ç½®ä¸ºä¸ `CustomTextInput` ä¸­çš„ `input` å…ƒç´ ç›¸å¯¹åº”çš„ DOM èŠ‚ç‚¹ã€‚

> æ³¨æ„ğŸ“¢ï¼š
>
> å¦‚æœ `ref` å›è°ƒå‡½æ•°æ˜¯ä»¥å†…è”å‡½æ•°çš„æ–¹å¼å®šä¹‰çš„ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å®ƒä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä¼ å…¥å‚æ•° `null`ï¼Œç„¶åç¬¬äºŒæ¬¡ä¼šä¼ å…¥å‚æ•° DOM å…ƒç´ ã€‚
>
> è¿™æ˜¯å› ä¸ºåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å®ä¾‹ï¼Œæ‰€ä»¥ React æ¸…ç©ºæ—§çš„ ref å¹¶ä¸”è®¾ç½®æ–°çš„ã€‚é€šè¿‡å°† ref çš„å›è°ƒå‡½æ•°å®šä¹‰æˆ `class` çš„ç»‘å®šå‡½æ•°çš„æ–¹å¼å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒæ˜¯æ— å…³ç´§è¦çš„ã€‚

