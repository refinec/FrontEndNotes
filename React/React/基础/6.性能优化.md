## æ€§èƒ½ä¼˜åŒ–

### ç»„ä»¶ä¸æ›´æ–°åˆ™ä¸é‡æ–°æ¸²æŸ“

> å½“ä¸€ä¸ªç»„ä»¶çš„ `props` æˆ– `state` å˜æ›´ï¼ŒReact ä¼šå°†æœ€æ–°è¿”å›çš„å…ƒç´ ä¸ä¹‹å‰æ¸²æŸ“çš„å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œä»¥æ­¤å†³å®šæ˜¯å¦æœ‰å¿…è¦æ›´æ–°çœŸå®çš„ DOMã€‚å½“å®ƒä»¬ä¸ç›¸åŒæ—¶ï¼ŒReact ä¼šæ›´æ–°è¯¥ DOMã€‚

ä½¿ç”¨å·¥å…·ï¼š`shouldComponentUpdate`ã€`React.PureComponent`

å¦‚æœä½ çš„ React ç»„ä»¶æ¸²æŸ“å¾ˆæ…¢ï¼Œä½ å¯ä»¥é€šè¿‡è¦†ç›–ç”Ÿå‘½å‘¨æœŸæ–¹æ³• `shouldComponentUpdate` æ¥è¿›è¡Œæé€Ÿã€‚è¯¥æ–¹æ³•ä¼šåœ¨é‡æ–°æ¸²æŸ“å‰è¢«è§¦å‘ã€‚å¦‚æœä½ çŸ¥é“åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½ çš„ç»„ä»¶ä¸éœ€è¦æ›´æ–°ï¼Œä½ å¯ä»¥åœ¨ `shouldComponentUpdate` ä¸­è¿”å› `false` æ¥è·³è¿‡æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹ï¼Œå…¶åŒ…æ‹¬è¯¥ç»„ä»¶çš„ `render` è°ƒç”¨ä»¥åŠä¹‹åçš„æ“ä½œã€‚

å…¶é»˜è®¤å®ç°æ€»æ˜¯è¿”å› `true`ï¼Œæ¥è®© React æ‰§è¡Œæ›´æ–°ï¼š

```jsx
shouldComponentUpdate(nextProps, nextState) {
  return true;
}
```

åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç»§æ‰¿ [`React.PureComponent`](https://zh-hans.reactjs.org/docs/react-api.html#reactpurecomponent) ä»¥ä»£æ›¿æ‰‹å†™ `shouldComponentUpdate()`ã€‚å®ƒç”¨å½“å‰ä¸ä¹‹å‰ `props` å’Œ `state` çš„**<u>æµ…æ¯”è¾ƒ</u>**è¦†å†™äº† `shouldComponentUpdate()` çš„å®ç°ã€‚

#### `shouldComponentUpdate` çš„ä½œç”¨

è¿™æ˜¯ä¸€ä¸ªReactç»„ä»¶çš„å­æ ‘ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œ`SCU` ä»£è¡¨ `shouldComponentUpdate` è¿”å›çš„å€¼ï¼Œè€Œ `vDOMEq` ä»£è¡¨è¿”å›çš„ React å…ƒç´ æ˜¯å¦ç›¸åŒã€‚æœ€åï¼Œåœ†åœˆçš„é¢œè‰²ä»£è¡¨äº†è¯¥ç»„ä»¶æ˜¯å¦éœ€è¦è¢«è°ƒåœã€‚

![](../../../assets/react/123sad.png)

èŠ‚ç‚¹ C2 çš„ `shouldComponentUpdate` è¿”å›äº† `false`ï¼ŒReact å› è€Œä¸ä¼šå»æ¸²æŸ“ C2ï¼Œä¹Ÿå› æ­¤ C4 å’Œ C5 çš„ `shouldComponentUpdate` ä¸ä¼šè¢«è°ƒç”¨åˆ°ã€‚

å¯¹äº C1 å’Œ C3ï¼Œ`shouldComponentUpdate` è¿”å›äº† `true`ï¼Œæ‰€ä»¥ React éœ€è¦ç»§ç»­å‘ä¸‹æŸ¥è¯¢å­èŠ‚ç‚¹ã€‚è¿™é‡Œ C6 çš„ `shouldComponentUpdate` è¿”å›äº† `true`ï¼ŒåŒæ—¶ç”±äºæ¸²æŸ“çš„å…ƒç´ ä¸ä¹‹å‰çš„ä¸åŒä½¿å¾— React æ›´æ–°äº†è¯¥ DOMã€‚

æœ€åä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­æ˜¯ C8ã€‚React éœ€è¦æ¸²æŸ“è¿™ä¸ªç»„ä»¶ï¼Œä½†æ˜¯ç”±äºå…¶è¿”å›çš„ React å…ƒç´ å’Œä¹‹å‰æ¸²æŸ“çš„ç›¸åŒï¼Œæ‰€ä»¥ä¸éœ€è¦æ›´æ–° DOMã€‚

æ˜¾è€Œæ˜“è§ï¼Œä½ çœ‹åˆ° React åªæ”¹å˜äº† C6 çš„ DOMã€‚å¯¹äº C8ï¼Œé€šè¿‡å¯¹æ¯”äº†æ¸²æŸ“çš„ React å…ƒç´ è·³è¿‡äº†æ¸²æŸ“ã€‚è€Œå¯¹äº C2 çš„å­èŠ‚ç‚¹å’Œ C7ï¼Œç”±äº `shouldComponentUpdate` ä½¿å¾— `render` å¹¶æ²¡æœ‰è¢«è°ƒç”¨ã€‚å› æ­¤å®ƒä»¬ä¹Ÿä¸éœ€è¦å¯¹æ¯”å…ƒç´ äº†ã€‚

##### ç¤ºä¾‹

å¦‚æœä½ çš„ç»„ä»¶åªæœ‰å½“ `props.color` æˆ–è€… `state.count` çš„å€¼æ”¹å˜æ‰éœ€è¦æ›´æ–°æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ `shouldComponentUpdate` æ¥è¿›è¡Œæ£€æŸ¥ï¼š

```jsx
class CounterButton extends React.Component {
  constructor(props) {
    super(props);
    this.state = {count: 1};
  }

  shouldComponentUpdate(nextProps, nextState) {
    if (this.props.color !== nextProps.color) {
      return true;
    }
    if (this.state.count !== nextState.count) {
      return true;
    }
    return false;
  }

  render() {
    return (
      <button
        color={this.props.color}
        onClick={() => this.setState(state => ({count: state.count + 1}))}>
        Count: {this.state.count}
      </button>
    );
  }
}
```

ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ`shouldComponentUpdate` ä»…æ£€æŸ¥äº† `props.color` æˆ– `state.count` æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœè¿™äº›å€¼æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆè¿™ä¸ªç»„ä»¶ä¸ä¼šæ›´æ–°ã€‚

å¦‚æœä½ çš„ç»„ä»¶æ›´å¤æ‚ä¸€äº›ï¼Œä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼â€œ**æµ…æ¯”è¾ƒ**â€çš„æ¨¡å¼æ¥æ£€æŸ¥ `props` å’Œ `state` ä¸­æ‰€æœ‰çš„å­—æ®µï¼Œä»¥æ­¤æ¥å†³å®šæ˜¯å¦ç»„ä»¶éœ€è¦æ›´æ–°ã€‚React å·²ç»æä¾›äº†ä¸€ä½å¥½å¸®æ‰‹æ¥å¸®ä½ å®ç°è¿™ç§å¸¸è§çš„æ¨¡å¼ - ä½ åªè¦ç»§æ‰¿ `React.PureComponent` å°±è¡Œäº†ã€‚æ‰€ä»¥ä¸Šé¢è¿™æ®µä»£ç å¯ä»¥æ”¹æˆä»¥ä¸‹è¿™ç§æ›´ç®€æ´çš„å½¢å¼ï¼š

```jsx
class CounterButton extends React.PureComponent {
  constructor(props) {
    super(props);
    this.state = {count: 1};
  }

  render() {
    return (
      <button
        color={this.props.color}
        onClick={() => this.setState(state => ({count: state.count + 1}))}>
        Count: {this.state.count}
      </button>
    );
  }
}
```

#### ä½¿ç”¨`React.PureComponent`çš„æ³¨æ„ç‚¹

> `React.PureComponent` åšçš„ä»…ä»…æ˜¯**æµ…æ¯”è¾ƒ**ï¼Œå¦‚æœ**æ–°æ•°æ®å¯¹è±¡å¼•ç”¨**ä¸**æ—§æ•°æ®å¯¹è±¡å¼•ç”¨**ç›¸åŒï¼Œåˆ™ä¸æ›´æ–°

å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `React.PureComponent` æ¥ä»£æ›¿æ‰‹å†™ `shouldComponentUpdate`ã€‚ä½†å®ƒåªè¿›è¡Œæµ…æ¯”è¾ƒï¼Œæ‰€ä»¥å½“ `props` æˆ–è€… `state` æŸç§ç¨‹åº¦æ˜¯å¯å˜çš„è¯ï¼Œæµ…æ¯”è¾ƒä¼šæœ‰é—æ¼ï¼Œé‚£ä½ å°±ä¸èƒ½ä½¿ç”¨å®ƒäº†ã€‚

å½“æ•°æ®ç»“æ„å¾ˆå¤æ‚æ—¶ï¼Œæƒ…å†µä¼šå˜å¾—éº»çƒ¦ã€‚ä¾‹å¦‚ï¼Œä½ æƒ³è¦ä¸€ä¸ª `ListOfWords` ç»„ä»¶æ¥æ¸²æŸ“ä¸€ç»„ç”¨é€—å·åˆ†å¼€çš„å•è¯ã€‚å®ƒæœ‰ä¸€ä¸ªå«åš `WordAdder` çš„çˆ¶ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å…è®¸ä½ ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®æ¥æ·»åŠ ä¸€ä¸ªå•è¯åˆ°åˆ—è¡¨ä¸­ã€‚ä»¥ä¸‹ä»£ç *å¹¶ä¸*æ­£ç¡®ï¼š

```jsx
class ListOfWords extends React.PureComponent {
  render() {
    return <div>{this.props.words.join(',')}</div>;
  }
}

class WordAdder extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      words: ['marklar']
    };
    this.handleClick = this.handleClick.bind(this);
  }

  handleClick() {
    // è¿™éƒ¨åˆ†ä»£ç å¾ˆç³Ÿï¼Œè€Œä¸”è¿˜æœ‰ bug
    const words = this.state.words;
    words.push('marklar');
    this.setState({words: words});
  }

  render() {
    return (
      <div>
        <button onClick={this.handleClick} />
        <ListOfWords words={this.state.words} />
      </div>
    );
  }
}
```

é—®é¢˜åœ¨äº `PureComponent` ä»…ä»…ä¼šå¯¹æ–°è€ `this.props.words` çš„å€¼è¿›è¡Œç®€å•çš„å¯¹æ¯”ã€‚ç”±äºä»£ç ä¸­ `WordAdder` çš„ `handleClick` æ–¹æ³•æ”¹å˜äº†åŒä¸€ä¸ª `words` æ•°ç»„ï¼Œä½¿å¾—æ–°è€ `this.props.words` æ¯”è¾ƒçš„å…¶å®è¿˜æ˜¯åŒä¸€ä¸ªæ•°ç»„ã€‚å³ä¾¿å®é™…ä¸Šæ•°ç»„ä¸­çš„å•è¯å·²ç»å˜äº†ï¼Œä½†æ˜¯æ¯”è¾ƒç»“æœæ˜¯ç›¸åŒçš„ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå³ä¾¿å¤šäº†æ–°çš„å•è¯éœ€è¦è¢«æ¸²æŸ“ï¼Œ `ListOfWords` å´å¹¶æ²¡æœ‰è¢«æ›´æ–°ã€‚

##### è§£å†³æ–¹æ¡ˆ

> æ”¹å˜æ•°æ®å¼•ç”¨å¯¹è±¡

é¿å…è¯¥é—®é¢˜æœ€ç®€å•çš„æ–¹å¼æ˜¯é¿å…æ›´æ”¹ä½ æ­£ç”¨äº `props` æˆ– `state` çš„å€¼ã€‚

ä¾‹å¦‚ï¼Œä¸Šé¢ `handleClick` æ–¹æ³•å¯ä»¥ç”¨ `concat`æˆ–è€…**æ‰©å±•è¿ç®—ç¬¦**ã€`Object.assign` ç­‰é‡å†™ï¼š

```jsx
handleClick() {
  this.setState(state => ({
    words: state.words.concat(['marklar'])
  }));
  // æˆ–è€…
  this.setState(state => ({
    words: [...state.words, 'marklar'],
  }));
}
```

#### `React.memo` (ç±»ä¼¼Vueçš„`keep-alive`?)

> å…è®¸ç»„ä»¶åœ¨ `props`æ²¡æœ‰æ”¹å˜çš„æƒ…å†µä¸‹è·³è¿‡æ¸²æŸ“ï¼ŒReact å°†è·³è¿‡æ¸²æŸ“ç»„ä»¶çš„æ“ä½œå¹¶ç›´æ¥å¤ç”¨æœ€è¿‘ä¸€æ¬¡æ¸²æŸ“çš„ç»“æœã€‚
>
> åœ¨ä½¿ç”¨`memo`ç¼“å­˜ç»„ä»¶åï¼ŒReactä¼šå¯¹æ¯ä¸€ä¸ª`prop`ä½¿ç”¨`Object.is`æ¯”è¾ƒæ–°å€¼å’Œè€å€¼ï¼Œè¿”å›`true`ï¼Œè¡¨ç¤ºæ²¡æœ‰å˜åŒ–ã€‚

```jsx
const MyComponent = React.memo(function MyComponent(props) {
  /* ä½¿ç”¨ props æ¸²æŸ“ */
  return <div>...</div>
});
```

##### ç‰¹ç‚¹

> **`React.memo` ä»…æ£€æŸ¥ props å˜æ›´**ã€‚å¦‚æœå‡½æ•°ç»„ä»¶è¢« `React.memo` åŒ…è£¹ï¼Œä¸”å…¶å®ç°ä¸­æ‹¥æœ‰ [`useState`](https://zh-hans.reactjs.org/docs/hooks-state.html)ï¼Œ[`useReducer`](https://zh-hans.reactjs.org/docs/hooks-reference.html#usereducer) æˆ– [`useContext`](https://zh-hans.reactjs.org/docs/hooks-reference.html#usecontext) çš„ Hookï¼Œå½“ `state` æˆ– `context` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä»ä¼šé‡æ–°æ¸²æŸ“ã€‚

é»˜è®¤æƒ…å†µä¸‹`React.memo`åªä¼šå¯¹å¤æ‚å¯¹è±¡åšæµ…å±‚å¯¹æ¯”(å¼•ç”¨åœ°å€æ˜¯å¦ç›¸åŒ)ï¼Œå¦‚æœä½ æƒ³è¦æ§åˆ¶å¯¹æ¯”è¿‡ç¨‹ï¼Œé‚£ä¹ˆè¯·å°†è‡ªå®šä¹‰çš„æ¯”è¾ƒå‡½æ•°é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥æ¥å®ç°ï¼ˆæ­¤æ–¹æ³•ä»…ä½œä¸º**æ€§èƒ½ä¼˜åŒ–**çš„æ–¹å¼è€Œå­˜åœ¨ã€‚ä½†è¯·ä¸è¦ä¾èµ–å®ƒæ¥â€œé˜»æ­¢â€æ¸²æŸ“ï¼Œå› ä¸ºè¿™ä¼šäº§ç”Ÿ **bug**ï¼‰ï¼š

```jsx
function MyComponent(props) {
  /* ä½¿ç”¨ props æ¸²æŸ“ */
}
function areEqual(prevProps, nextProps) {
  /*
  å¦‚æœæŠŠ nextProps ä¼ å…¥ render æ–¹æ³•çš„è¿”å›ç»“æœä¸
  å°† prevProps ä¼ å…¥ render æ–¹æ³•çš„è¿”å›ç»“æœä¸€è‡´åˆ™è¿”å› trueï¼Œ
  å¦åˆ™è¿”å› false
  */
}
export default React.memo(MyComponent, areEqual);
```

> **æ³¨æ„ğŸ“¢**ï¼š
>
> ä¸ class ç»„ä»¶ä¸­ [`shouldComponentUpdate()`](https://zh-hans.reactjs.org/docs/react-component.html#shouldcomponentupdate) æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œå¦‚æœ props ç›¸ç­‰ï¼Œ`areEqual` ä¼šè¿”å› `true`ï¼›å¦‚æœ props ä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› `false`ã€‚è¿™ä¸ `shouldComponentUpdate` æ–¹æ³•çš„è¿”å›å€¼ç›¸åã€‚
