## ä¸€ã€è¯·æ±‚è€—æ—¶ç»Ÿè®¡ï¼šä¸ºä»€ä¹ˆé‡è¦ï¼Ÿé€‚ç”¨äºå“ªäº›åœºæ™¯ï¼Ÿ

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°è¿™äº›åœºæ™¯ï¼š

- æŸä¸ªé¡µé¢æ•°æ®åŠ è½½å¾ˆæ…¢ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªæ¥å£æ‹–äº†åè…¿ï¼›
- ç”¨æˆ·é¢‘ç¹æŠ•è¯‰é¡µé¢å¡é¡¿ï¼Œä½†åç«¯è¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ï¼›
- éœ€è¦å¯¹æ¥å‰ç«¯ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ `Fundebug`ã€`Sentry`ã€`LogRocket`ï¼‰åšæ¥å£è€—æ—¶ä¸ŠæŠ¥ã€‚

è¿™æ—¶å°±éœ€è¦ä¸€å¥—**â€œå…¨ç«™è¯·æ±‚è€—æ—¶ç»Ÿè®¡å·¥å…·â€**æ¥åšä¸‰ä»¶äº‹ï¼š

1. **æ•æ‰è¯·æ±‚ï¼š** æ‹¦æˆªæ‰€æœ‰é¡µé¢å‘èµ·çš„ HTTP è¯·æ±‚ï¼›
2. **è®¡ç®—è€—æ—¶ï¼š** è®°å½•è¯·æ±‚çš„å‘å‡ºå’Œå“åº”æ—¶é—´ï¼Œè®¡ç®—æ€»è€—æ—¶ï¼›
3. **ä¸ŠæŠ¥æ•°æ®ï¼š** å°†ç»Ÿè®¡ç»“æœå‘é€åˆ°ç›‘æ§å¹³å°æˆ–è€…æ‰“å°å‡ºæ¥ç”¨äºè°ƒè¯•ã€‚

## äºŒã€å®ç°æ–¹æ³•

### 1. è¯·æ±‚æ‹¦æˆªï¼Œç”¨ç»Ÿä¸€å…¥å£ç›‘æ§ä¸€åˆ‡è¯·æ±‚

> æˆ‘ä»¬å¸¸ç”¨çš„è¯·æ±‚æ–¹å¼æœ‰ä¸¤ç§ï¼š`XMLHttpRequest` å’Œ `Fetch`ã€‚è¦å®ç°å…¨ç«™ç›‘æ§ï¼Œæˆ‘ä»¬è¦å¯¹å®ƒä»¬è¿›è¡Œ**â€œæ‹¦æˆªâ€**ï¼Œä¹Ÿå°±æ˜¯**é‡å†™å®ƒä»¬çš„è¡Œä¸º**ã€‚

1. ä»£ç å®ç°ï¼ˆ`Fetch`ä¸ºä¾‹ï¼‰

	```js
     constÂ originalFetch =Â window.fetch;
   
     window.fetch =Â async functionÂ (...args)Â {
     constÂ start =Â Date.now();
     tryÂ {
         // ä¿è¯åŸæœ‰ fetch çš„ä¸Šä¸‹æ–‡å’Œå‚æ•°ä¸å˜
         constÂ response =Â awaitÂ originalFetch.apply(this, args);
         constÂ end =Â Date.now();
   
         reportTiming(args[0], end - start);Â // ä¸ŠæŠ¥åœ°å€ & è€—æ—¶
         returnÂ response;
       }Â catchÂ (err) {
         constÂ end =Â Date.now();
         reportTiming(args[0], end - start,Â true);
         throwÂ err;
       }
     };
   
     functionÂ reportTiming(url, duration, isError = false)Â {
     console.log(`[è¯·æ±‚ç›‘æ§]Â ${url}Â -Â ${duration}msÂ ${isError ?Â '(å¤±è´¥)'Â :Â ''}`);
     //Â TODO:Â ä¸ŠæŠ¥ç»™æœåŠ¡ç«¯æˆ–ç›‘æ§å¹³å°
     }
   ```

2. ä»£ç å®ç°ï¼ˆåŠ«æŒåŸç”Ÿ `XMLHttpRequest`ï¼‰

	> è™½ç„¶ `fetch` å·²æ™®åŠï¼Œä½†ä¸å°‘è€é¡¹ç›®ä»å¤§é‡ä½¿ç”¨ `axios` æˆ– jQueryï¼Œè¿™äº›é»˜è®¤åŸºäº `XMLHttpRequest` å®ç°ã€‚æ‹¦æˆª `XHR` æ˜¯å®ç°**å…¨é¢è¦†ç›–**çš„å…³é”®ã€‚

	```js
   constÂ originalXHR =Â window.XMLHttpRequest;
   
   functionÂ wrapXHR()Â {
     constÂ oldOpen = originalXHR.prototype.open;
     constÂ oldSend = originalXHR.prototype.send;
   
     // åŠ«æŒÂ openÂ æ˜¯ä¸ºäº†ä¿å­˜è¯·æ±‚åœ°å€
     originalXHR.prototype.open =Â functionÂ (method, url, async)Â {
       this._url = url;
       oldOpen.apply(this,Â arguments);
     };
   
     // åŠ«æŒÂ sendÂ æ˜¯ä¸ºäº†æ³¨å…¥Â loadendÂ äº‹ä»¶, äº‹ä»¶ä¸­è·å–å“åº”æ—¶é—´ï¼Œé€‚é…æ‰€æœ‰çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
     originalXHR.prototype.send =Â functionÂ (...args)Â {
       constÂ start =Â Date.now();
   
       this.addEventListener('loadend', () => {
         constÂ duration =Â Date.now() - start;
         reportTiming(this._url, duration,Â this.status >=Â 400);
       });
   
       oldSend.apply(this, args);
     };
   }
   
   wrapXHR();
   ```

### 2. ä½¿ç”¨ sendBeacon ä¸ŠæŠ¥ç›‘æ§æ•°æ®

> ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ fetch ä¸ŠæŠ¥ç›‘æ§ï¼Ÿ
>
> å› ä¸ºå¦‚æœä½ ç”¨ `fetch` å†å»ä¸ŠæŠ¥è€—æ—¶ä¿¡æ¯ï¼Œä¼š**å†æ¬¡è§¦å‘ç›‘æ§é€»è¾‘**ï¼Œé€ æˆæ­»å¾ªç¯ã€‚

ä»€ä¹ˆæ˜¯`navigator.sendBeacon`ï¼Ÿ

> [navigator.sendBeacon](https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon) æ˜¯ç›®å‰é€šç”¨çš„åŸ‹ç‚¹ä¸ŠæŠ¥æ–¹æ¡ˆï¼Œå®ƒä¸»è¦ç”¨äºå°†ç»Ÿè®¡æ•°æ®é€šè¿‡ [HTTP POST](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Methods/POST) å°†å°‘é‡æ•°æ® [å¼‚æ­¥](https://developer.mozilla.org/zh-CN/docs/Glossary/Asynchronous) ä¼ è¾“åˆ° Web æœåŠ¡å™¨ï¼ŒåŒæ—¶é¿å…äº†ç”¨ä¼ ç»ŸæŠ€æœ¯ï¼ˆå¦‚ï¼š[`XMLHttpRequest`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest)ï¼‰å‘é€åˆ†ææ•°æ®çš„ä¸€äº›é—®é¢˜ã€‚
>
> è¯­æ³•ï¼š`navigator.sendBeacon(url, data)`

**sendBeacon çš„ä¼˜ç‚¹**

- **å¼‚æ­¥ & éé˜»å¡**ï¼Œä¸ä¼šé˜»ç¢ä¸»çº¿ç¨‹ï¼›
- **ä¸ä¼šè§¦å‘å†æ¬¡è¯·æ±‚åŠ«æŒ**ï¼›
- **åœ¨é¡µé¢å¸è½½æ—¶ä»èƒ½æ­£å¸¸å‘é€**ï¼Œéå¸¸é€‚åˆæ”¶å°¾é˜¶æ®µä¸ŠæŠ¥ã€‚

#### å®ç°

```js
functionÂ reportTiming(url, duration, isError = false)Â {
Â Â constÂ data = {
Â  Â  url,
Â  Â  duration,
Â  Â Â status: isError ?Â 'error'Â :Â 'ok',
Â  Â Â timestamp:Â Date.now(),
Â  };

Â Â constÂ blob =Â newÂ Blob([JSON.stringify(data)], {Â type:Â 'application/json'Â });
Â  navigator.sendBeacon('/monitor/collect', blob);
}
```



> æ³¨ğŸ“¢ï¼šå¦‚æœä½ çš„é¡¹ç›®åœ¨ä½¿ç”¨æ—¥å¿—é‡‡é›†å·¥å…·ï¼ˆå¦‚ `Sentry`ã€`é˜¿é‡Œäº‘å‰ç«¯ç›‘æ§`ï¼‰ï¼Œå¯å°† `reportTiming` æ¥å…¥è¿™äº› SDK çš„ `track` æ¥å£ä¸­ã€‚

å¦‚æœä½ å¸Œæœ›æ›´è¿›ä¸€æ­¥ï¼Œå¯ä»¥è€ƒè™‘è¿™äº›ä¼˜åŒ–ï¼š

- **æŒ‰ URL åˆ†ç»„ç»Ÿè®¡**ï¼Œåˆ†æå“ªä¸ªæ¥å£æœ€æ…¢ï¼›
- **é‡‡æ ·ç­–ç•¥**ï¼Œæ¯”å¦‚åªè®°å½• `10%` ç”¨æˆ·çš„æ•°æ®ï¼›
- **ç¼“å­˜è¿‘æœŸè¯·æ±‚è€—æ—¶åˆ—è¡¨**ï¼Œåœ¨æ§åˆ¶å°å¯è§†åŒ–æ¸²æŸ“è¯·æ±‚æ’è¡Œï¼›
- **é¡µé¢çº§å¹³å‡è€—æ—¶è®¡ç®—**ï¼Œå¯æ‰“é€šæ€§èƒ½ç›‘æ§é“¾è·¯ã€‚

è¿™äº›æ‰©å±•éƒ½èƒ½æ˜¾è‘—æå‡ç³»ç»Ÿç›‘æ§ç²’åº¦ä¸å¯ç”¨æ€§



## ä¸‰ã€æ‰©å±•ï¼šå¸¸è§çš„åŸ‹ç‚¹è¡Œä¸º

### ç»Ÿè®¡æ•°æ®ä¸Šä¼ 

> ç½‘ç«™é€šå¸¸å¸Œæœ›åœ¨ç”¨æˆ·å®Œæˆé¡µé¢æµè§ˆåå‘æœåŠ¡å™¨å‘é€åˆ†ææˆ–è¯Šæ–­æ•°æ®ï¼Œæœ€å¯é çš„æ–¹æ³•æ˜¯åœ¨ [`visibilitychange`](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FDocument%2Fvisibilitychange_event) äº‹ä»¶å‘ç”Ÿæ—¶å‘é€æ•°æ®ï¼š

```js
document.addEventListener("visibilitychange", function logData() {
  if (document.visibilityState === "hidden") {
    navigator.sendBeacon("/log", analyticsData);
  }
});
```

æˆ‘ä»¬åº”è¯¥é¿å…ä½¿ç”¨ `unload` å’Œ `beforeunload` äº‹ä»¶ï¼Œè¿‡å»ï¼Œè®¸å¤šç½‘ç«™ä½¿ç”¨ [`unload`](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2Funload_event) äº‹ä»¶ä»¥åœ¨ä¼šè¯ç»“æŸæ—¶å‘é€ç»Ÿè®¡æ•°æ®ã€‚ç„¶è€Œè¿™æ˜¯ä¸å¯é çš„ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ˆå°¤å…¶æ˜¯ç§»åŠ¨è®¾å¤‡ï¼‰æµè§ˆå™¨ä¸ä¼šäº§ç”Ÿ `unload`ã€`beforeunload` æˆ– `pagehide` äº‹ä»¶ã€‚ä¸‹é¢åˆ—å‡ºäº†ä¸€ç§ä¸è§¦å‘ä¸Šè¿°äº‹ä»¶çš„æƒ…å†µï¼š

1. ç”¨æˆ·åŠ è½½äº†ç½‘é¡µå¹¶ä¸å…¶äº¤äº’
2. å®Œæˆæµè§ˆåï¼Œç”¨æˆ·åˆ‡æ¢åˆ°äº†å…¶ä»–åº”ç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯å…³é—­é€‰é¡¹å¡
3. éšåï¼Œç”¨æˆ·é€šè¿‡æ‰‹æœºçš„åº”ç”¨ç®¡ç†å™¨å…³é—­äº†æµè§ˆå™¨åº”ç”¨

æ­¤å¤–ï¼Œ`unload` äº‹ä»¶ä¸ç°ä»£æµè§ˆå™¨å®ç°çš„å¾€è¿”ç¼“å­˜ä¸å…¼å®¹

1. **ç‚¹å‡»è§¦å‘åŸ‹ç‚¹**

   ```js
   function clickButton(url, data) {
       navigator.sendBeacon(url, data)
   }
   ```

2. **é¡µé¢åœç•™ä¸ŠæŠ¥**

   1. æ–¹å¼ä¸€ï¼šè·¯ç”±æ–‡ä»¶ä¸­ï¼Œåˆå§‹åŒ–ä¸€ä¸ª`startTime`ï¼Œå½“é¡µé¢ç¦»å¼€æ—¶é€šè¿‡è·¯ç”±å®ˆå«è®¡ç®—åœç•™æ—¶é—´

      ```js
      let url = ''// ä¸ŠæŠ¥åœ°å€
      let startTime = Date.now()
      let currentTime = ''
      router.beforeEach((to, from, next) => { 
           if (to) {
               currentTime = Date.now()
               stayTime = parseInt(currentTime - startTime)
               navigator.sendBeacon(url, {time: stayTime})
               startTime = Date.now()
           }
       })
      ```

3. **é”™è¯¯ç›‘å¬åŸ‹ç‚¹**

   1. Vue é”™è¯¯æ•è·

      ```js
      app.config.errorHandler = (err) => { 
          navigator.sendBeacon(url, {error: error.message, text: 'vueè¿è¡Œå¼‚å¸¸' })
      }
      ```

   2. JSå¼‚å¸¸ä¸é™æ€èµ„æºåŠ è½½å¼‚å¸¸ï¼Œ`error` å¯ä»¥ç›‘å¬æ‰€æœ‰åŒæ­¥ã€å¼‚æ­¥çš„è¿è¡Œæ—¶é”™è¯¯ï¼Œä½†æ— æ³•ç›‘å¬è¯­æ³•ã€æ¥å£ã€èµ„æºåŠ è½½é”™è¯¯

      ```js
      window.addEventListener('error', (error) => { 
          if (error.message) { 
              navigator.sendBeacon(url, {error: error.message, text: 'jsæ‰§è¡Œå¼‚å¸¸' })
          } else { 
              navigator.sendBeacon(url, {error: error.filename, text: 'èµ„æºåŠ è½½å¼‚å¸¸' })
          } 
      }, true)
      ```

   3. `unhandledrejection` å¯ä»¥ç›‘å¬åˆ° `Promise` ä¸­æŠ›å‡ºçš„ï¼Œæœªè¢« `catch` æ•è·çš„é”™è¯¯

      ```js
      window.addEventListener("unhandledrejection", (event) => {
        console.warn(`æœªå¤„ç†çš„ Promise rejection : ${event.reason}`);
      });
      // æˆ–è€…
      window.onunhandledrejection = (event) => {
        console.warn(`æœªå¤„ç†çš„ Promise rejection : ${event.reason}`);
      };
      ```
